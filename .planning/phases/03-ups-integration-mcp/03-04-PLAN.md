---
phase: 03-ups-integration-mcp
plan: 04
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - packages/ups-mcp/src/tools/shipping.ts
  - packages/ups-mcp/src/utils/labels.ts
  - packages/ups-mcp/src/index.ts
  - packages/ups-mcp/tests/shipping.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create shipment and receive tracking number"
    - "PDF label is saved to configured output directory"
    - "User can void an existing shipment by tracking number"
    - "User can reprint a label for existing tracking number"
    - "Label filename follows {tracking_number}.pdf format"
  artifacts:
    - path: "packages/ups-mcp/src/tools/shipping.ts"
      provides: "Shipping tools implementation"
      exports: ["registerShippingTools"]
    - path: "packages/ups-mcp/src/utils/labels.ts"
      provides: "Label file handling utilities"
      exports: ["saveLabel"]
    - path: "packages/ups-mcp/tests/shipping.test.ts"
      provides: "Unit tests for shipping tools"
      contains: "shipping_create"
  key_links:
    - from: "packages/ups-mcp/src/index.ts"
      to: "packages/ups-mcp/src/tools/shipping.ts"
      via: "registerShippingTools(server)"
      pattern: "registerShippingTools"
    - from: "packages/ups-mcp/src/tools/shipping.ts"
      to: "packages/ups-mcp/src/utils/labels.ts"
      via: "saveLabel"
      pattern: "saveLabel"
---

<objective>
Implement shipping_create, shipping_void, and shipping_get_label MCP tools for UPS shipment management.

Purpose: Enable users to create shipments with PDF labels, void shipments, and reprint labels. This supports the UPS-03 and OUT-01 requirements for shipment creation and label generation.

Output: Three registered MCP tools for full shipment lifecycle management with automatic PDF label storage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ups-integration-mcp/03-RESEARCH.md
@.planning/phases/03-ups-integration-mcp/03-02-SUMMARY.md
@docs/shipping.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create label handling utilities</name>
  <files>
    packages/ups-mcp/src/utils/labels.ts
  </files>
  <action>
    Create utilities for decoding and saving PDF labels:

    1. Create src/utils/labels.ts:

    ```typescript
    import { writeFile, mkdir } from 'node:fs/promises';
    import { join } from 'node:path';

    /**
     * Save a Base64-encoded PDF label to the filesystem.
     * @param trackingNumber - UPS tracking number (used as filename)
     * @param base64Data - Base64-encoded PDF content
     * @param outputDir - Directory to save labels to
     * @returns Full path to saved label file
     */
    export async function saveLabel(
      trackingNumber: string,
      base64Data: string,
      outputDir: string
    ): Promise<string> {
      // Ensure output directory exists
      await mkdir(outputDir, { recursive: true });

      // Decode Base64 to binary
      const buffer = Buffer.from(base64Data, 'base64');

      // Build file path: {outputDir}/{trackingNumber}.pdf
      const filePath = join(outputDir, `${trackingNumber}.pdf`);

      // Write file
      await writeFile(filePath, buffer);

      return filePath;
    }

    /**
     * Extract label from UPS shipment response.
     * UPS returns labels in: ShipmentResponse.ShipmentResults.PackageResults[].ShippingLabel.GraphicImage
     */
    export function extractLabelFromResponse(response: any): { trackingNumber: string; base64Data: string }[] {
      const results = response.ShipmentResponse?.ShipmentResults?.PackageResults || [];

      return results.map((pkg: any) => ({
        trackingNumber: pkg.TrackingNumber,
        base64Data: pkg.ShippingLabel?.GraphicImage
      })).filter((item: any) => item.base64Data);
    }
    ```

    Per CONTEXT.md Decision 3:
    - PDF only format
    - Filename format: {tracking_number}.pdf
    - Flat directory structure (no subdirectories)
    - MCP saves labels directly
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    grep "saveLabel" packages/ups-mcp/src/utils/labels.ts
    grep "extractLabelFromResponse" packages/ups-mcp/src/utils/labels.ts
  </verify>
  <done>
    Label utilities decode Base64 PDFs and save with tracking number filename
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement shipping tools</name>
  <files>
    packages/ups-mcp/src/tools/shipping.ts
  </files>
  <action>
    Create shipping tools module with all three tools:

    1. Create src/tools/shipping.ts:

    Define input schemas:
    ```typescript
    const ShipmentRequestInputSchema = z.object({
      shipper: z.object({
        name: z.string(),
        attentionName: z.string().optional(),
        phone: z.string(),
        addressLine1: z.string(),
        addressLine2: z.string().optional(),
        city: z.string(),
        stateProvinceCode: z.string(),
        postalCode: z.string(),
        countryCode: z.string().default('US')
      }),
      shipTo: z.object({
        name: z.string(),
        attentionName: z.string().optional(),
        phone: z.string(),
        addressLine1: z.string(),
        addressLine2: z.string().optional(),
        city: z.string(),
        stateProvinceCode: z.string(),
        postalCode: z.string(),
        countryCode: z.string().default('US')
      }),
      packages: z.array(z.object({
        weight: z.number().describe('Weight in pounds'),
        length: z.number().optional(),
        width: z.number().optional(),
        height: z.number().optional(),
        packagingType: z.string().default('02'),
        description: z.string().optional()
      })),
      serviceCode: z.string().describe('UPS service code (e.g., "03" for Ground)'),
      description: z.string().optional().describe('Shipment description'),
      reference: z.string().optional().describe('Customer reference number')
    });

    const VoidRequestSchema = z.object({
      trackingNumber: z.string().describe('UPS tracking number to void')
    });

    const GetLabelRequestSchema = z.object({
      trackingNumber: z.string().describe('UPS tracking number to get label for')
    });
    ```

    2. Implement shipping_create tool:
    - POST to /shipments/v2409/ship
    - Request body structure per UPS Shipping API spec
    - Request PDF label format in LabelSpecification
    - Extract tracking number(s) from response
    - Save label(s) using saveLabel utility
    - Return: tracking numbers, label file paths, charges

    3. Implement shipping_void tool:
    - DELETE to /shipments/v2409/void/cancel/{trackingNumber}
    - Return: success boolean, void status from UPS

    4. Implement shipping_get_label tool:
    - POST to /labels/v2409/recovery with tracking number
    - Extract and save label
    - Return: label file path
    - Per CONTEXT.md: Overwrites existing file if present

    5. Export registerShippingTools(server, apiClient, labelsOutputDir)
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    grep "shipping_create" packages/ups-mcp/src/tools/shipping.ts
    grep "shipping_void" packages/ups-mcp/src/tools/shipping.ts
    grep "shipping_get_label" packages/ups-mcp/src/tools/shipping.ts
  </verify>
  <done>
    All three shipping tools implemented with proper schemas and UPS API calls
  </done>
</task>

<task type="auto">
  <name>Task 3: Register shipping tools and add tests</name>
  <files>
    packages/ups-mcp/src/index.ts
    packages/ups-mcp/tests/shipping.test.ts
  </files>
  <action>
    1. Update src/index.ts to register shipping tools:
    ```typescript
    import { registerShippingTools } from './tools/shipping.js';

    // After creating server and apiClient:
    registerShippingTools(server, apiClient, config.labelsOutputDir);
    ```

    2. Create tests/shipping.test.ts:
    - Test: shipping_create builds correct UPS request structure
    - Test: shipping_create extracts tracking number from response
    - Test: shipping_create saves label file
    - Test: shipping_void calls correct endpoint
    - Test: shipping_get_label retrieves and saves label
    - Test: label filename follows {tracking}.pdf format

    Mock apiClient.request and verify file operations.

    Sample UPS shipping response for mocking:
    ```json
    {
      "ShipmentResponse": {
        "ShipmentResults": {
          "ShipmentCharges": {
            "TotalCharges": { "CurrencyCode": "USD", "MonetaryValue": "15.50" }
          },
          "PackageResults": [{
            "TrackingNumber": "1Z999AA10123456784",
            "ShippingLabel": {
              "ImageFormat": { "Code": "PDF" },
              "GraphicImage": "JVBERi0xLjQK..."
            }
          }]
        }
      }
    }
    ```

    3. Update tests to mock filesystem:
    - Mock fs/promises writeFile and mkdir
    - Verify label content is Base64 decoded correctly
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    cd packages/ups-mcp && pnpm test -- shipping.test.ts
    grep "registerShippingTools" packages/ups-mcp/src/index.ts
  </verify>
  <done>
    Shipping tools registered with MCP server, unit tests passing
  </done>
</task>

</tasks>

<verification>
All verification commands should pass:

```bash
# Label utilities exist
test -f packages/ups-mcp/src/utils/labels.ts && echo "OK: labels.ts exists"
grep "saveLabel" packages/ups-mcp/src/utils/labels.ts

# Shipping tools exist
test -f packages/ups-mcp/src/tools/shipping.ts && echo "OK: shipping.ts exists"
grep "shipping_create" packages/ups-mcp/src/tools/shipping.ts
grep "shipping_void" packages/ups-mcp/src/tools/shipping.ts
grep "shipping_get_label" packages/ups-mcp/src/tools/shipping.ts

# Registered with server
grep "registerShippingTools" packages/ups-mcp/src/index.ts

# TypeScript compiles
cd packages/ups-mcp && pnpm run build

# Tests pass
cd packages/ups-mcp && pnpm test -- shipping.test.ts
```
</verification>

<success_criteria>
- shipping_create accepts shipper, shipTo, packages, serviceCode
- shipping_create calls UPS Shipping API and extracts tracking numbers
- shipping_create saves PDF labels to LABELS_OUTPUT_DIR/{tracking}.pdf
- shipping_void cancels shipment by tracking number via UPS API
- shipping_get_label retrieves and saves label for existing tracking number
- Label files are valid decoded PDFs (not still Base64)
- Tools registered with MCP server via registerShippingTools
- Unit tests pass with mocked UPS responses
</success_criteria>

<output>
After completion, create `.planning/phases/03-ups-integration-mcp/03-04-SUMMARY.md`
</output>
