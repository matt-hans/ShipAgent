---
phase: 03-ups-integration-mcp
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - packages/ups-mcp/src/tools/rating.ts
  - packages/ups-mcp/src/index.ts
  - packages/ups-mcp/tests/rating.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can get rate quote for a specific UPS service"
    - "User can compare rates across all available UPS services"
    - "Rate responses include itemized cost breakdown"
    - "Rate responses include delivery date and time window"
    - "Unavailable services are returned with reason, not omitted"
  artifacts:
    - path: "packages/ups-mcp/src/tools/rating.ts"
      provides: "Rating tools implementation"
      exports: ["registerRatingTools"]
    - path: "packages/ups-mcp/tests/rating.test.ts"
      provides: "Unit tests for rating tools"
      contains: "rating_quote"
  key_links:
    - from: "packages/ups-mcp/src/index.ts"
      to: "packages/ups-mcp/src/tools/rating.ts"
      via: "registerRatingTools(server)"
      pattern: "registerRatingTools"
    - from: "packages/ups-mcp/src/tools/rating.ts"
      to: "packages/ups-mcp/src/client/api.ts"
      via: "apiClient.request"
      pattern: "apiClient\\.request"
---

<objective>
Implement rating_quote and rating_shop MCP tools for getting UPS shipping rates.

Purpose: Enable users to get rate quotes for specific services or compare all available services before creating shipments. This supports the UPS-02 requirement for pre-shipment rate quotes.

Output: Two registered MCP tools that query UPS Rating API and return structured rate data with cost breakdowns and transit times.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ups-integration-mcp/03-RESEARCH.md
@.planning/phases/03-ups-integration-mcp/03-02-SUMMARY.md
@docs/rating.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rating tools with input/output schemas</name>
  <files>
    packages/ups-mcp/src/tools/rating.ts
  </files>
  <action>
    Create rating tools module with Zod schemas for inputs and outputs:

    1. Create src/tools/rating.ts:

    Define input schema for rating requests:
    ```typescript
    const RateRequestInputSchema = z.object({
      shipFrom: z.object({
        name: z.string(),
        addressLine1: z.string(),
        addressLine2: z.string().optional(),
        city: z.string(),
        stateProvinceCode: z.string(),
        postalCode: z.string(),
        countryCode: z.string().default('US')
      }),
      shipTo: z.object({
        name: z.string(),
        addressLine1: z.string(),
        addressLine2: z.string().optional(),
        city: z.string(),
        stateProvinceCode: z.string(),
        postalCode: z.string(),
        countryCode: z.string().default('US')
      }),
      packages: z.array(z.object({
        weight: z.number().describe('Weight in pounds'),
        length: z.number().optional().describe('Length in inches'),
        width: z.number().optional().describe('Width in inches'),
        height: z.number().optional().describe('Height in inches'),
        packagingType: z.string().default('02').describe('02=Package, 01=Letter')
      })),
      serviceCode: z.string().optional().describe('UPS service code (e.g., "03" for Ground). Required for rating_quote')
    });
    ```

    Define output schema for rate responses:
    ```typescript
    const RateResponseSchema = z.object({
      service: z.object({
        code: z.string(),
        name: z.string()
      }),
      available: z.boolean(),
      unavailableReason: z.string().optional(),
      totalCharges: z.object({
        currency: z.string(),
        amount: z.string()
      }).optional(),
      breakdown: z.array(z.object({
        type: z.string(),
        currency: z.string(),
        amount: z.string()
      })).optional(),
      deliveryDate: z.string().optional(),
      deliveryTime: z.string().optional(),
      businessDays: z.number().optional()
    });
    ```

    2. Implement rating_quote tool:
    - Calls POST /rating/v2409/Ratetimeintransit with specific service
    - Maps UPS response to output schema
    - Extracts: base charge, fuel surcharge, accessorial charges, total
    - Extracts: estimated delivery date and time

    3. Implement rating_shop tool:
    - Calls POST /rating/v2409/Shoptimeintransit
    - Returns array of RateResponse for all services
    - Per CONTEXT.md: Unavailable services marked with available=false and reason

    4. Export registerRatingTools(server: McpServer, apiClient: UpsApiClient) function
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    grep "rating_quote" packages/ups-mcp/src/tools/rating.ts
    grep "rating_shop" packages/ups-mcp/src/tools/rating.ts
    grep "registerRatingTools" packages/ups-mcp/src/tools/rating.ts
  </verify>
  <done>
    Rating tools defined with Zod input/output schemas, both rating_quote and rating_shop implemented
  </done>
</task>

<task type="auto">
  <name>Task 2: Transform UPS rating response to structured output</name>
  <files>
    packages/ups-mcp/src/tools/rating.ts
  </files>
  <action>
    Add response transformation logic to extract cost breakdown and transit times:

    1. Create transformRateResponse function:
    ```typescript
    function transformRateResponse(upsResponse: any): RateResponse[] {
      const ratedShipment = upsResponse.RateResponse?.RatedShipment || [];

      return ratedShipment.map(rated => {
        const service = rated.Service;
        const charges = rated.TotalCharges;
        const breakdown = [];

        // Base transportation charge
        if (rated.TransportationCharges) {
          breakdown.push({
            type: 'Transportation',
            currency: rated.TransportationCharges.CurrencyCode,
            amount: rated.TransportationCharges.MonetaryValue
          });
        }

        // Fuel surcharge
        if (rated.FuelSurcharge) {
          breakdown.push({
            type: 'Fuel Surcharge',
            currency: rated.FuelSurcharge.CurrencyCode,
            amount: rated.FuelSurcharge.MonetaryValue
          });
        }

        // Itemized charges
        if (rated.ItemizedCharges) {
          rated.ItemizedCharges.forEach(charge => {
            breakdown.push({
              type: charge.Description || charge.Code,
              currency: charge.CurrencyCode,
              amount: charge.MonetaryValue
            });
          });
        }

        // Time in transit
        const transit = rated.TimeInTransit;

        return {
          service: {
            code: service.Code,
            name: getServiceName(service.Code)
          },
          available: true,
          totalCharges: charges ? {
            currency: charges.CurrencyCode,
            amount: charges.MonetaryValue
          } : undefined,
          breakdown,
          deliveryDate: transit?.ServiceSummary?.EstimatedArrival?.Date,
          deliveryTime: transit?.ServiceSummary?.EstimatedArrival?.Time,
          businessDays: transit?.ServiceSummary?.EstimatedArrival?.BusinessDaysInTransit
        };
      });
    }
    ```

    2. Create getServiceName mapping:
    ```typescript
    const SERVICE_NAMES: Record<string, string> = {
      '01': 'UPS Next Day Air',
      '02': 'UPS 2nd Day Air',
      '03': 'UPS Ground',
      '12': 'UPS 3 Day Select',
      '13': 'UPS Next Day Air Saver',
      '14': 'UPS Next Day Air Early',
      '59': 'UPS 2nd Day Air A.M.',
      '65': 'UPS Saver',
      // Add more as needed
    };
    ```

    3. Handle unavailable services:
    When UPS returns warning codes for services that can't deliver:
    - Mark available: false
    - Extract reason from warning message
    - Still include in response array
  </action>
  <verify>
    grep "transformRateResponse" packages/ups-mcp/src/tools/rating.ts
    grep "SERVICE_NAMES" packages/ups-mcp/src/tools/rating.ts
    grep "breakdown" packages/ups-mcp/src/tools/rating.ts
  </verify>
  <done>
    Response transformation extracts full cost breakdown and transit times from UPS response format
  </done>
</task>

<task type="auto">
  <name>Task 3: Register tools with MCP server and add tests</name>
  <files>
    packages/ups-mcp/src/index.ts
    packages/ups-mcp/tests/rating.test.ts
  </files>
  <action>
    1. Update src/index.ts to register rating tools:
    ```typescript
    import { registerRatingTools } from './tools/rating.js';

    // After creating server and apiClient:
    registerRatingTools(server, apiClient);
    ```

    2. Create tests/rating.test.ts:
    - Test: rating_quote builds correct UPS request
    - Test: rating_quote transforms response with cost breakdown
    - Test: rating_shop returns multiple services
    - Test: unavailable services marked correctly
    - Test: missing optional fields handled gracefully

    Mock the apiClient.request method to return sample UPS responses.

    Sample UPS rating response structure for mocking:
    ```json
    {
      "RateResponse": {
        "RatedShipment": [{
          "Service": { "Code": "03" },
          "TotalCharges": { "CurrencyCode": "USD", "MonetaryValue": "12.50" },
          "TransportationCharges": { "CurrencyCode": "USD", "MonetaryValue": "10.00" },
          "FuelSurcharge": { "CurrencyCode": "USD", "MonetaryValue": "2.50" },
          "TimeInTransit": {
            "ServiceSummary": {
              "EstimatedArrival": {
                "Date": "20250128",
                "Time": "235959",
                "BusinessDaysInTransit": 3
              }
            }
          }
        }]
      }
    }
    ```

    3. Verify tools are registered by checking server exports.
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    cd packages/ups-mcp && pnpm test -- rating.test.ts
    grep "registerRatingTools" packages/ups-mcp/src/index.ts
  </verify>
  <done>
    Rating tools registered with MCP server, unit tests passing
  </done>
</task>

</tasks>

<verification>
All verification commands should pass:

```bash
# Rating tools module exists
test -f packages/ups-mcp/src/tools/rating.ts && echo "OK: rating.ts exists"

# Tools exported
grep "rating_quote" packages/ups-mcp/src/tools/rating.ts
grep "rating_shop" packages/ups-mcp/src/tools/rating.ts

# Response transformation
grep "breakdown" packages/ups-mcp/src/tools/rating.ts
grep "deliveryDate" packages/ups-mcp/src/tools/rating.ts

# Registered with server
grep "registerRatingTools" packages/ups-mcp/src/index.ts

# TypeScript compiles
cd packages/ups-mcp && pnpm run build

# Tests pass
cd packages/ups-mcp && pnpm test -- rating.test.ts
```
</verification>

<success_criteria>
- rating_quote tool accepts ship from/to addresses, packages, and service code
- rating_shop tool accepts same input but returns all available services
- Rate responses include itemized cost breakdown (base, fuel, accessorials)
- Rate responses include delivery date, time window, and business days
- Unavailable services returned with available=false and reason (not omitted)
- Tools registered with MCP server via registerRatingTools
- Unit tests pass with mocked UPS responses
</success_criteria>

<output>
After completion, create `.planning/phases/03-ups-integration-mcp/03-03-SUMMARY.md`
</output>
