---
phase: 03-ups-integration-mcp
plan: 06
type: execute
wave: 4
depends_on: ["03-03", "03-04", "03-05"]
files_modified:
  - packages/ups-mcp/tests/integration.test.ts
  - packages/ups-mcp/package.json
autonomous: false
user_setup:
  - service: ups
    why: "Integration tests require valid UPS sandbox credentials"
    env_vars:
      - name: UPS_CLIENT_ID
        source: "UPS Developer Portal -> My Apps -> App Details"
      - name: UPS_CLIENT_SECRET
        source: "UPS Developer Portal -> My Apps -> App Details"
      - name: UPS_ACCOUNT_NUMBER
        source: "UPS Developer Portal -> My Apps -> Account Numbers"
    dashboard_config:
      - task: "Create sandbox application"
        location: "developer.ups.com -> My Apps -> Add App"

must_haves:
  truths:
    - "OAuth token can be obtained from UPS sandbox"
    - "Rate quote returns valid pricing for test addresses"
    - "Shipment creation returns tracking number in sandbox"
    - "Address validation returns result for test address"
    - "All 6 MCP tools respond correctly"
  artifacts:
    - path: "packages/ups-mcp/tests/integration.test.ts"
      provides: "End-to-end integration tests against UPS sandbox"
      contains: "describe"
  key_links:
    - from: "packages/ups-mcp/tests/integration.test.ts"
      to: "UPS sandbox API"
      via: "HTTPS"
      pattern: "wwwcie.ups.com"
---

<objective>
Create end-to-end integration tests against UPS sandbox environment.

Purpose: Verify all 6 MCP tools work correctly with real UPS sandbox API responses. This validates the complete integration from tool input through UPS API to structured output.

Output: Comprehensive integration test suite that exercises all tools against UPS sandbox.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ups-integration-mcp/03-RESEARCH.md
@.planning/phases/03-ups-integration-mcp/03-03-SUMMARY.md
@.planning/phases/03-ups-integration-mcp/03-04-SUMMARY.md
@.planning/phases/03-ups-integration-mcp/03-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create integration test framework</name>
  <files>
    packages/ups-mcp/tests/integration.test.ts
    packages/ups-mcp/package.json
  </files>
  <action>
    Set up integration test infrastructure:

    1. Add integration test script to package.json:
    ```json
    {
      "scripts": {
        "test": "vitest run",
        "test:unit": "vitest run --exclude '**/integration.test.ts'",
        "test:integration": "vitest run integration.test.ts"
      }
    }
    ```

    2. Create tests/integration.test.ts with test setup:
    ```typescript
    import { describe, it, expect, beforeAll } from 'vitest';
    import { UpsAuthManager } from '../src/auth/manager.js';
    import { UpsApiClient } from '../src/client/api.js';
    import { config, validateConfig } from '../src/config.js';

    // Skip integration tests if no credentials
    const RUN_INTEGRATION = process.env.UPS_CLIENT_ID &&
                            process.env.UPS_CLIENT_SECRET &&
                            process.env.UPS_ACCOUNT_NUMBER;

    describe.skipIf(!RUN_INTEGRATION)('UPS Integration Tests', () => {
      let authManager: UpsAuthManager;
      let apiClient: UpsApiClient;

      beforeAll(() => {
        const conf = validateConfig();
        authManager = new UpsAuthManager(conf.clientId, conf.clientSecret);
        apiClient = new UpsApiClient(authManager, conf.baseUrl);
      });

      // Test data
      const testShipFrom = {
        name: 'Test Shipper',
        addressLine1: '1400 16th St',
        city: 'San Francisco',
        stateProvinceCode: 'CA',
        postalCode: '94103',
        countryCode: 'US'
      };

      const testShipTo = {
        name: 'Test Recipient',
        addressLine1: '350 5th Ave',
        city: 'New York',
        stateProvinceCode: 'NY',
        postalCode: '10118',
        countryCode: 'US'
      };

      const testPackage = {
        weight: 5,
        length: 10,
        width: 8,
        height: 6
      };

      // Tests will be added in next steps
    });
    ```

    Use real addresses for test data - UPS sandbox validates addresses.
  </action>
  <verify>
    cd packages/ups-mcp && pnpm run build
    grep "test:integration" packages/ups-mcp/package.json
    grep "describe" packages/ups-mcp/tests/integration.test.ts
  </verify>
  <done>
    Integration test framework set up with conditional execution based on credentials
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for all 6 tools</name>
  <files>
    packages/ups-mcp/tests/integration.test.ts
  </files>
  <action>
    Add integration tests for each MCP tool:

    1. OAuth authentication test:
    ```typescript
    it('obtains OAuth token from UPS sandbox', async () => {
      const token = await authManager.getToken();
      expect(token).toBeTruthy();
      expect(typeof token).toBe('string');
      expect(token.length).toBeGreaterThan(10);
    });
    ```

    2. rating_quote test:
    ```typescript
    it('gets rate quote for Ground service', async () => {
      // Build rate request for UPS Ground (code 03)
      const response = await apiClient.request('POST', '/rating/v2409/Ratetimeintransit', {
        RateRequest: {
          Request: { SubVersion: '1801' },
          Shipment: {
            Shipper: { ... },
            ShipTo: { ... },
            ShipFrom: { ... },
            Service: { Code: '03' },
            Package: [{ ... }]
          }
        }
      });

      expect(response.RateResponse).toBeDefined();
      expect(response.RateResponse.RatedShipment).toBeDefined();
      expect(response.RateResponse.RatedShipment[0].TotalCharges).toBeDefined();
    });
    ```

    3. rating_shop test:
    ```typescript
    it('gets rates for all available services', async () => {
      const response = await apiClient.request('POST', '/rating/v2409/Shoptimeintransit', {
        RateRequest: { ... }
      });

      expect(response.RateResponse.RatedShipment.length).toBeGreaterThan(1);
    });
    ```

    4. address_validate test:
    ```typescript
    it('validates address and returns classification', async () => {
      const response = await apiClient.request('POST', '/addressvalidation/v2/1', {
        XAVRequest: {
          AddressKeyFormat: {
            AddressLine: ['350 5th Ave'],
            PoliticalDivision2: 'New York',
            PoliticalDivision1: 'NY',
            PostcodePrimaryLow: '10118',
            CountryCode: 'US'
          }
        }
      });

      expect(response.XAVResponse).toBeDefined();
      // Should have either ValidAddressIndicator or Candidate
      const hasValid = 'ValidAddressIndicator' in response.XAVResponse;
      const hasCandidates = response.XAVResponse.Candidate?.length > 0;
      expect(hasValid || hasCandidates).toBe(true);
    });
    ```

    5. shipping_create test (sandbox creates real test labels):
    ```typescript
    it('creates shipment and returns tracking number', async () => {
      const response = await apiClient.request('POST', '/shipments/v2409/ship', {
        ShipmentRequest: {
          Request: { SubVersion: '1801' },
          Shipment: {
            Shipper: { ... },
            ShipTo: { ... },
            ShipFrom: { ... },
            Service: { Code: '03' },
            Package: [{ ... }],
            PaymentInformation: {
              ShipmentCharge: [{
                Type: '01',
                BillShipper: { AccountNumber: config.accountNumber }
              }]
            }
          },
          LabelSpecification: {
            LabelImageFormat: { Code: 'PDF' },
            LabelStockSize: { Height: '6', Width: '4' }
          }
        }
      });

      expect(response.ShipmentResponse?.ShipmentResults).toBeDefined();
      const results = response.ShipmentResponse.ShipmentResults;
      expect(results.PackageResults[0].TrackingNumber).toBeTruthy();
      expect(results.PackageResults[0].ShippingLabel?.GraphicImage).toBeTruthy();
    }, 30000); // 30s timeout for shipping
    ```

    6. Save tracking number for void test
    7. shipping_void test (void the created shipment)
  </action>
  <verify>
    grep "rating_quote\|rating_shop\|shipping_create\|shipping_void\|address_validate" packages/ups-mcp/tests/integration.test.ts
    grep "obtains OAuth token" packages/ups-mcp/tests/integration.test.ts
  </verify>
  <done>
    Integration tests added for OAuth, rating_quote, rating_shop, address_validate, shipping_create, shipping_void
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete UPS MCP integration tests. The tests require real UPS sandbox credentials.
  </what-built>
  <how-to-verify>
    1. Set environment variables:
       ```bash
       export UPS_CLIENT_ID="your-client-id"
       export UPS_CLIENT_SECRET="your-client-secret"
       export UPS_ACCOUNT_NUMBER="your-account-number"
       ```

    2. Run integration tests:
       ```bash
       cd packages/ups-mcp && pnpm test:integration
       ```

    3. Verify all tests pass:
       - OAuth token obtained
       - Rate quotes returned with pricing
       - Shipment created with tracking number
       - Label saved to filesystem
       - Address validation returns result

    4. Check generated label file exists in ./labels/ directory
  </how-to-verify>
  <resume-signal>Type "approved" if all integration tests pass, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
All verification commands should pass:

```bash
# Integration test file exists
test -f packages/ups-mcp/tests/integration.test.ts && echo "OK: integration tests exist"

# Test scripts defined
grep "test:integration" packages/ups-mcp/package.json

# All tools have tests
grep -c "it\(" packages/ups-mcp/tests/integration.test.ts  # Should be >= 6

# TypeScript compiles
cd packages/ups-mcp && pnpm run build

# Unit tests still pass (without credentials)
cd packages/ups-mcp && pnpm test:unit
```
</verification>

<success_criteria>
- Integration test file exists with tests for all 6 tools
- Tests skip gracefully when credentials not set
- With valid UPS sandbox credentials:
  - OAuth token obtained successfully
  - rating_quote returns pricing for specific service
  - rating_shop returns multiple services with rates
  - address_validate returns valid/ambiguous/invalid status
  - shipping_create returns tracking number and label
  - shipping_void successfully voids shipment
- Label PDF saved to filesystem
- All tests pass against UPS sandbox
</success_criteria>

<output>
After completion, create `.planning/phases/03-ups-integration-mcp/03-06-SUMMARY.md`
</output>
