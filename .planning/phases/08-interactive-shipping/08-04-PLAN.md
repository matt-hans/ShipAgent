---
phase: 08-interactive-shipping
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - tests/services/test_interactive_shipping.py
  - tests/api/test_interactive_routes.py
  - tests/frontend_type_check.sh
autonomous: true

must_haves:
  truths:
    - "Schema generator produces valid flat JSON Schema with correct required fields"
    - "Pre-filled fields appear as defaults, missing fields have no defaults"
    - "Field extraction correctly parses weight, name, address, service from NL commands"
    - "Interactive API endpoints return correct response shapes"
    - "Single-row job creation produces valid Job and JobRow records"
    - "Interactive job can be submitted, previewed, confirmed, and executed end-to-end"
    - "Existing tests remain unaffected (no regressions)"
  artifacts:
    - path: "tests/services/test_interactive_shipping.py"
      provides: "Unit tests for schema generator, field extraction, and job creation"
      min_lines: 100
    - path: "tests/api/test_interactive_routes.py"
      provides: "API integration tests for interactive endpoints including E2E confirm flow"
      min_lines: 80
  key_links:
    - from: "tests/services/test_interactive_shipping.py"
      to: "src/services/interactive_shipping.py"
      via: "import and test all public functions"
      pattern: "from src.services.interactive_shipping import"
    - from: "tests/api/test_interactive_routes.py"
      to: "src/api/routes/interactive.py"
      via: "FastAPI TestClient for endpoint testing"
      pattern: "TestClient"
    - from: "tests/api/test_interactive_routes.py"
      to: "src/api/routes/preview.py"
      via: "Tests POST /jobs/{id}/confirm on interactive jobs to verify E2E flow"
      pattern: "confirm"
---

<objective>
Write comprehensive tests for the interactive shipping feature: unit tests for the schema generator, field extractor, and job creation, plus API integration tests for the interactive endpoints including an end-to-end test of the full interactive flow (start -> submit -> confirm -> execute).

Purpose: Verify all Phase 8 requirements are met with automated tests, with particular attention to the confirm/execute path for interactive jobs. The confirm endpoint in `src/api/routes/preview.py` was built for batch jobs -- the E2E test verifies it works correctly for single-row interactive jobs too. The schema generator is deterministic, so it has well-defined input/output behavior that is ideal for thorough unit testing.

Output: Test files covering all interactive shipping logic with edge cases, including E2E integration test for Success Criterion 5.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-interactive-shipping/08-01-SUMMARY.md
@.planning/phases/08-interactive-shipping/08-02-SUMMARY.md
@.planning/phases/08-interactive-shipping/08-03-SUMMARY.md

@src/services/interactive_shipping.py
@src/api/routes/interactive.py
@src/api/routes/preview.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for interactive shipping service</name>
  <files>tests/services/test_interactive_shipping.py</files>
  <action>
Create `tests/services/test_interactive_shipping.py` with comprehensive tests:

**Schema Generation Tests (`TestGenerateShippingFormSchema`):**

1. `test_empty_initial_data_returns_all_fields` - When initial_data is `{}`, schema should contain ALL required + optional fields. Required list should have all 7 required field names.

2. `test_all_fields_provided_shows_defaults` - When all required fields provided in initial_data, they should appear as `default` values in schema properties. Message should say "All required fields found."

3. `test_partial_data_prefills_provided_fields` - When some fields provided (e.g., `ship_to_name` and `weight`), those should have `default` values, others should not. Message should say "Found 2 of 7 required fields."

4. `test_schema_is_flat_json_schema` - Verify schema has `type: "object"`, `properties` dict, `required` list. No nested objects. All property types are primitives (string, number).

5. `test_service_code_has_oneOf` - Verify `service_code` property has `oneOf` array with correct UPS service entries (03, 02, 01, 12, 13).

6. `test_weight_constraints` - Verify `weight` property has minimum 0.1, maximum 150, type "number".

7. `test_state_has_pattern` - Verify `ship_to_state` has pattern `^[A-Z]{2}$`.

8. `test_zip_has_pattern` - Verify `ship_to_postal_code` has pattern for 5-digit or ZIP+4.

9. `test_optional_fields_included` - Verify optional fields (ship_to_address2, ship_to_phone, ship_to_company, length, width, height) are in properties but NOT in required.

10. `test_none_values_in_initial_data_treated_as_missing` - When initial_data has `{"weight": None}`, weight should NOT have a default.

11. `test_empty_string_values_treated_as_missing` - When initial_data has `{"ship_to_name": ""}`, ship_to_name should NOT have a default.

**Field Extraction Tests (`TestExtractShippingFields`):**

12. `test_extracts_weight_lbs` - "Ship a 5lb box" -> `{"weight": 5.0}`

13. `test_extracts_weight_with_space` - "Ship a 5 lb box" -> `{"weight": 5.0}`

14. `test_extracts_weight_decimal` - "Ship a 2.5 lbs package" -> `{"weight": 2.5}`

15. `test_extracts_name_after_to` - "Ship to John Smith at ..." -> `{"ship_to_name": "John Smith"}`

16. `test_extracts_service_ground` - "... using UPS Ground" -> `{"service_code": "03"}`

17. `test_extracts_service_overnight` - "... via overnight" -> `{"service_code": "01"}`

18. `test_extracts_zip_code` - "... NY 10001" -> `{"ship_to_postal_code": "10001"}`

19. `test_extracts_state_code` - "... New York NY ..." -> `{"ship_to_state": "NY"}`

20. `test_empty_command_returns_empty_dict` - "" -> `{}`

21. `test_no_shipping_info_returns_empty_dict` - "Hello world" -> `{}`

22. `test_full_extraction` - "Ship a 5lb box to John Smith at 123 Main St, New York NY 10001 via Ground" -> should extract weight, name, address, city, state, zip, service.

**Job Creation Tests (`TestCreateInteractiveJobRow`):**

23. `test_creates_job_and_row` - With valid form_data, creates Job with correct name and JobRow with row_number=1.

24. `test_applies_default_country` - When form_data lacks `ship_to_country`, it should default to "US" in order_data.

25. `test_applies_default_packaging` - When form_data lacks `packaging_type`, it should default to "02".

26. `test_row_checksum_is_sha256` - Verify row_checksum is a valid hex SHA-256 string (64 chars, hex digits).

27. `test_order_data_is_valid_json` - Verify JobRow.order_data is parseable JSON containing the form fields.

Use `pytest` fixtures. For job creation tests, use an in-memory SQLite database (follow existing test patterns in `tests/conftest.py`).
  </action>
  <verify>
    Run: `pytest tests/services/test_interactive_shipping.py -v --no-header 2>&1 | tail -30` - All tests pass.
  </verify>
  <done>
    - 27+ unit tests covering schema generation, field extraction, and job creation
    - All edge cases tested: empty data, partial data, full data, None values, empty strings
    - Schema MCP compliance verified (flat, primitive types only)
    - Field extraction deterministic behavior verified
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: API integration tests including E2E confirm/execute flow</name>
  <files>tests/api/test_interactive_routes.py</files>
  <action>
Create `tests/api/test_interactive_routes.py` with API endpoint tests:

Use FastAPI TestClient with the app from `src.api.main`.

**Setup:**
- Import `TestClient` from `fastapi.testclient`
- Import `app` from `src.api.main`
- Create `client = TestClient(app)` in fixture

**Start Endpoint Tests:**

1. `test_start_button_mode_returns_full_schema` - POST `/api/v1/interactive/start?mode=button` with `{"command": ""}`. Verify response has `action: "elicit"`, `schema` with all required fields, `message`, `initial_data` is empty dict.

2. `test_start_with_nl_command_returns_partial_schema` - POST `/api/v1/interactive/start` with `{"command": "Ship a 5lb box to John Smith"}`. Verify response has pre-filled fields in schema defaults.

3. `test_start_response_schema_is_flat` - Verify returned schema has `type: "object"`, all properties are primitive types, no nested objects.

4. `test_start_response_has_required_fields` - Verify `schema.required` contains the expected field names.

**Submit Endpoint Tests:**

5. `test_submit_with_valid_data_returns_preview` - POST `/api/v1/interactive/submit` with complete form_data. Verify response has `job_id` and `preview` with `total_rows: 1`. Note: UPS rating will fail in test env, so preview may show $0 cost -- that's expected.

6. `test_submit_missing_required_fields_returns_422` - POST with form_data missing required fields. Verify 422 response.

7. `test_submit_creates_job_in_database` - After successful submit, verify job exists in database with correct status and total_rows=1.

8. `test_submit_creates_single_job_row` - After successful submit, verify exactly 1 JobRow exists for the job.

**End-to-End Flow Test (Success Criterion 5 coverage):**

9. `test_confirm_interactive_job_triggers_execution` - This is the critical E2E test that verifies the full interactive flow works through the existing confirm endpoint:
   a. POST `/api/v1/interactive/submit` with complete form_data -> get `job_id`
   b. Verify job exists in DB with `status="pending"` and `total_rows=1`
   c. POST `/api/v1/jobs/{job_id}/confirm` (the EXISTING confirm endpoint in preview.py)
   d. Verify response has `status: "confirmed"` and appropriate message
   e. Verify job status transitions to `"running"` in the database
   f. Use mock for BatchEngine.execute (or UPSService.create_shipment) to simulate successful execution without hitting real UPS API
   g. After a short wait (for the background task), verify job status is `"completed"` (or at minimum, that the confirm endpoint accepted the interactive job without error)

   This test proves that a single-row job created by the interactive submit endpoint is fully compatible with the existing batch confirm/execute infrastructure.

10. `test_confirm_interactive_job_rejects_non_pending` - Submit an interactive job, manually update its status to "completed", then POST confirm. Verify 400 error "Only pending jobs can be confirmed."

**Use mocking for UPS calls:**
Mock `UPSService` to avoid real API calls:
```python
@pytest.fixture(autouse=True)
def mock_ups_service(monkeypatch):
    """Mock UPS service to avoid real API calls in tests."""
    async def mock_preview(self, job_id, rows, shipper, service_code):
        return {
            "preview_rows": [{
                "row_number": 1,
                "estimated_cost_cents": 1299,
                "rate_error": None,
            }]
        }
    monkeypatch.setattr(
        "src.services.batch_engine.BatchEngine.preview",
        mock_preview,
    )
```

Also mock `build_shipper_from_env` to return a valid shipper dict without requiring env vars:
```python
monkeypatch.setattr(
    "src.services.ups_payload_builder.build_shipper_from_env",
    lambda: {"Name": "Test", "Address": {"AddressLine": ["123 Test"], "City": "Test", "StateProvinceCode": "NY", "PostalCode": "10001", "CountryCode": "US"}, "ShipperNumber": "TEST123"},
)
```

For the E2E confirm test (test 9), also mock `BatchEngine.execute` to simulate successful single-row execution:
```python
async def mock_execute(self, job_id, rows, shipper, on_progress=None):
    """Mock execute that simulates successful single-row shipment."""
    if on_progress:
        await on_progress("row_completed", row_number=1, tracking_number="1Z999TEST0001", cost_cents=1299)
    return {"successful": 1, "failed": 0, "total_cost_cents": 1299}
```

**Regression Tests:**

11. `test_existing_command_endpoint_still_works` - POST `/api/v1/commands` with a batch command still works (response has `job_id`).

12. `test_existing_job_endpoints_unaffected` - GET `/api/v1/jobs` still returns job list.

Ensure all test functions have proper docstrings.
  </action>
  <verify>
    Run: `pytest tests/api/test_interactive_routes.py -v --no-header 2>&1 | tail -20` - All tests pass.
    Run: `pytest tests/ -k "not test_stream_endpoint_exists and not sse" --no-header -q 2>&1 | tail -5` - Full test suite passes (no regressions).
  </verify>
  <done>
    - 12+ API integration tests covering start, submit, and confirm endpoints
    - Button mode and NL command mode both tested
    - Submit creates correct Job + JobRow records
    - Missing field validation returns 422
    - E2E test verifies full flow: submit -> confirm -> execute for interactive jobs
    - Confirm endpoint compatibility with single-row interactive jobs verified
    - UPS service properly mocked for test environment
    - Existing endpoints verified unaffected (regression tests)
    - All tests pass, no regressions in full suite
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/services/test_interactive_shipping.py -v` - All unit tests pass
2. `pytest tests/api/test_interactive_routes.py -v` - All API tests pass (including E2E confirm flow)
3. `pytest tests/ -k "not test_stream_endpoint_exists and not sse and not edi" --no-header -q 2>&1 | tail -5` - Full suite passes
4. `cd frontend && npx tsc --noEmit` - TypeScript still compiles
</verification>

<success_criteria>
- 39+ new tests across 2 test files
- Schema generator behavior fully covered with edge cases
- Field extraction deterministic behavior verified
- API endpoints return correct response shapes
- Job creation produces valid database records
- E2E test proves interactive submit -> confirm -> execute flow works
- No regressions in existing test suite
- All Phase 8 requirements verifiable through tests:
  - INT-01: Single shipment via conversation (test_submit_with_valid_data + test_confirm_interactive_job_triggers_execution)
  - INT-02: MCP-compliant flat JSON Schema (test_schema_is_flat_json_schema)
  - INT-03: Field-type-aware form (tested via schema structure)
  - INT-04: Intent parser recognizes interactive commands (test_start_with_nl_command)
  - INT-05: Comprehensive elicitation (test_empty_initial_data_returns_all_fields)
  - INT-06: Interactive Ship button (test_start_button_mode_returns_full_schema)
  - INT-07: Minimal LLM tokens (no LLM calls in schema generation - verified by code inspection)
  - SC-5: Complete shipment from conversational input (test_confirm_interactive_job_triggers_execution)
</success_criteria>

<output>
After completion, create `.planning/phases/08-interactive-shipping/08-04-SUMMARY.md`
</output>
