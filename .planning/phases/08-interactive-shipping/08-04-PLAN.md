---
phase: 08-interactive-shipping
plan: 04
type: execute
wave: 3
depends_on: ["08-01", "08-02", "08-03"]
files_modified:
  - tests/services/test_interactive_shipping.py
  - tests/api/test_interactive_endpoint.py
autonomous: true

must_haves:
  truths:
    - "Unit tests verify generate_form_schema() with various partial data inputs"
    - "Unit tests verify build_order_data_from_form() merges defaults and validates"
    - "API integration tests verify POST /interactive/submit returns preview data"
    - "All existing tests still pass (no regressions)"
  artifacts:
    - path: "tests/services/test_interactive_shipping.py"
      provides: "Unit tests for InteractiveShippingService"
      min_lines: 80
    - path: "tests/api/test_interactive_endpoint.py"
      provides: "API integration tests for interactive submit endpoint"
      min_lines: 60
  key_links:
    - from: "tests/services/test_interactive_shipping.py"
      to: "src/services/interactive_shipping.py"
      via: "import and test generate_form_schema, build_order_data_from_form"
      pattern: "generate_form_schema"
    - from: "tests/api/test_interactive_endpoint.py"
      to: "src/api/routes/interactive.py"
      via: "TestClient POST to /api/v1/interactive/submit"
      pattern: "interactive/submit"
---

<objective>
Write comprehensive unit and API integration tests for the interactive shipping feature. Cover schema generation edge cases, form data validation, and the submit endpoint.

Purpose: Ensure the deterministic schema generator and form submission pipeline work correctly for all field combinations, and the API endpoint handles both valid and invalid requests properly.

Output: `tests/services/test_interactive_shipping.py`, `tests/api/test_interactive_endpoint.py`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/services/interactive_shipping.py
@src/api/routes/interactive.py
@src/api/schemas_interactive.py
@tests/services/test_ups_payload_builder.py
@tests/api/test_jobs_api.py
@.planning/phases/08-interactive-shipping/08-01-SUMMARY.md
@.planning/phases/08-interactive-shipping/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for InteractiveShippingService</name>
  <files>tests/services/test_interactive_shipping.py</files>
  <action>
Create `tests/services/test_interactive_shipping.py` with the following test cases:

**Test generate_form_schema():**

1. `test_empty_provided_data_returns_all_required_fields`:
   - Call `generate_form_schema({})`, assert all 7 required fields are in `properties` and `required`
   - Assert optional fields (address2, phone, company, length, width, height) are in `properties` but NOT in `required`
   - Assert `prefilled` is empty dict

2. `test_partial_data_excludes_provided_fields`:
   - Call with `{"ship_to_name": "John", "weight": 5.0}`
   - Assert `ship_to_name` NOT in `properties` (provided)
   - Assert `weight` NOT in `properties` (provided)
   - Assert `ship_to_address1` IS in `properties` (missing)
   - Assert `prefilled == {"ship_to_name": "John", "weight": 5.0}`

3. `test_all_required_provided_returns_empty_schema`:
   - Provide all 7 required fields with valid values
   - Assert `properties` is empty or only has optional fields
   - Assert `required` is empty

4. `test_service_code_has_oneOf`:
   - Call with empty data
   - Assert `service_code` property has `oneOf` with at least 5 entries
   - Assert each oneOf entry has `const` and `title`
   - Assert default is "03"

5. `test_weight_field_has_numeric_constraints`:
   - Assert weight property has `type: "number"`, `minimum: 0.1`, `maximum: 150`

6. `test_state_field_has_max_length`:
   - Assert ship_to_state has `maxLength: 2`

7. `test_schema_is_flat_json_schema`:
   - Assert top-level `type == "object"`
   - Assert no nested objects in properties (each property has primitive type)

**Test build_order_data_from_form():**

8. `test_valid_form_data_returns_order_data`:
   - Pass complete form data
   - Assert returned dict has all fields
   - Assert defaults are applied (ship_to_country="US", packaging_type="02")

9. `test_missing_required_field_raises_value_error`:
   - Pass form data missing `ship_to_name`
   - Assert `ValueError` raised with descriptive message

10. `test_defaults_can_be_overridden`:
    - Pass `ship_to_country="CA"` in form data
    - Assert returned dict has `ship_to_country == "CA"`

11. `test_optional_fields_included_when_provided`:
    - Pass complete required + `ship_to_phone: "555-1234"`
    - Assert returned dict includes phone

12. `test_optional_fields_absent_when_not_provided`:
    - Pass only required fields
    - Assert returned dict does not contain phone, company, dimensions

Use standard pytest patterns. Import directly:
```python
from src.services.interactive_shipping import (
    generate_form_schema,
    build_order_data_from_form,
    REQUIRED_FIELDS,
    OPTIONAL_FIELDS,
    DEFAULT_FIELDS,
)
```
  </action>
  <verify>
Run: `pytest tests/services/test_interactive_shipping.py -v` -- all tests pass.
  </verify>
  <done>12+ unit tests covering schema generation (empty, partial, full data), field constraints (oneOf, min/max, maxLength), order data building (defaults, validation, optional fields). All pass.</done>
</task>

<task type="auto">
  <name>Task 2: API integration tests for interactive submit endpoint</name>
  <files>tests/api/test_interactive_endpoint.py</files>
  <action>
Create `tests/api/test_interactive_endpoint.py` with API integration tests using FastAPI TestClient.

**Setup**: Use `from fastapi.testclient import TestClient` and `from src.api.main import app`. Mock the UPS MCP client to avoid real API calls.

**Test cases:**

1. `test_submit_valid_form_returns_preview`:
   - POST `/api/v1/interactive/submit` with complete valid body
   - Mock `_get_ups_client` to return a mock that returns rate data
   - Assert 200 status
   - Assert response has `job_id`, `status == "preview_ready"`, `total_rows == 1`
   - Assert `total_estimated_cost_cents` is a positive integer

2. `test_submit_missing_required_field_returns_422`:
   - POST with missing `ship_to_name`
   - Assert 422 status (Pydantic validation error)

3. `test_submit_invalid_weight_returns_422`:
   - POST with `weight: 0` (below minimum)
   - Assert 422 status

4. `test_submit_invalid_weight_too_heavy_returns_422`:
   - POST with `weight: 200` (above 150 max)
   - Assert 422 status

5. `test_submit_defaults_applied`:
   - POST without `service_code` and `ship_to_country`
   - Assert job is created with defaults (service_code="03", ship_to_country="US")

6. `test_submit_creates_job_in_db`:
   - POST valid form
   - Mock UPS client
   - Use the returned `job_id` to fetch from `/api/v1/jobs/{job_id}`
   - Assert job exists with name containing "Interactive"
   - Assert `total_rows == 1`

7. `test_submit_with_optional_dimensions`:
   - POST with length=10, width=8, height=6
   - Assert 200 status (optional fields accepted)

**Mocking pattern** (follow existing test patterns in the codebase):
```python
from unittest.mock import AsyncMock, patch

@patch("src.api.routes.interactive._get_ups_client")
async def test_...(mock_ups):
    mock_client = AsyncMock()
    mock_client.get_rate.return_value = {"cost_cents": 1250, "service": "03"}
    mock_ups.return_value = mock_client
    ...
```

If the codebase uses `pytest-asyncio` or synchronous TestClient, follow whichever pattern existing tests use. Check `tests/api/` for the established pattern.

Include proper docstrings and use descriptive test names.
  </action>
  <verify>
Run: `pytest tests/api/test_interactive_endpoint.py -v -k "not stream and not sse"` -- all tests pass.
Run: `pytest tests/services/test_interactive_shipping.py tests/api/test_interactive_endpoint.py -v` -- all pass together.
Run: `pytest -x -k "not test_stream_endpoint_exists and not edi" --tb=short 2>&1 | tail -20` -- no regressions in existing tests.
  </verify>
  <done>7+ API integration tests covering valid submission, validation errors (missing fields, invalid weight), default application, job creation verification, and optional field handling. All pass. No regressions in existing test suite.</done>
</task>

</tasks>

<verification>
1. `pytest tests/services/test_interactive_shipping.py -v` -- all pass
2. `pytest tests/api/test_interactive_endpoint.py -v` -- all pass
3. `pytest -x -k "not test_stream_endpoint_exists and not edi" --tb=short` -- no regressions
4. Test coverage for interactive_shipping.py: generate_form_schema, build_order_data_from_form, edge cases
5. Test coverage for interactive endpoint: valid, invalid, defaults, DB verification
</verification>

<success_criteria>
- 12+ unit tests for InteractiveShippingService pass
- 7+ API integration tests for /interactive/submit pass
- Schema generation tested with empty, partial, and complete data
- Form validation tested with missing fields and invalid values
- Defaults verified (service_code, country, packaging_type)
- No regressions in existing 777+ tests
</success_criteria>

<output>
After completion, create `.planning/phases/08-interactive-shipping/08-04-SUMMARY.md`
</output>
