---
phase: 08-interactive-shipping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/interactive_shipping.py
  - src/orchestrator/models/intent.py
  - src/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "Deterministic schema generator produces flat JSON Schema from partial shipping data"
    - "Schema includes all UPS-required fields with correct types, constraints, and defaults"
    - "Fields already provided by user appear as pre-filled defaults in the schema"
    - "ShippingIntent model supports is_interactive flag and initial_data dict"
    - "API schemas define ElicitationResponse and InteractiveShipmentRequest contracts"
  artifacts:
    - path: "src/services/interactive_shipping.py"
      provides: "ShippingFormSchemaGenerator with generate_shipping_form_schema()"
      exports: ["generate_shipping_form_schema", "UPS_REQUIRED_FIELDS", "UPS_OPTIONAL_FIELDS", "UPS_DEFAULT_FIELDS", "create_interactive_job_row"]
    - path: "src/orchestrator/models/intent.py"
      provides: "Extended ShippingIntent with is_interactive and initial_data"
      contains: "is_interactive"
    - path: "src/api/schemas.py"
      provides: "ElicitationResponse and InteractiveShipmentRequest Pydantic schemas"
      contains: "ElicitationResponse"
  key_links:
    - from: "src/services/interactive_shipping.py"
      to: "src/services/ups_payload_builder.py"
      via: "build_shipment_request import for payload construction"
      pattern: "from src.services.ups_payload_builder import"
    - from: "src/services/interactive_shipping.py"
      to: "src/db/models.py"
      via: "Job and JobRow model imports for single-row job creation"
      pattern: "from src.db.models import"
---

<objective>
Create the backend core for interactive shipping: the deterministic schema generator service, extended intent model, and API schemas.

Purpose: This is the foundation of Phase 8. The schema generator computes missing UPS fields from partial user data without any LLM calls (requirement INT-07: <500 tokens). The intent model extension and API schemas define the contracts that routing and frontend plans depend on.

Output: `src/services/interactive_shipping.py` with schema generation and job creation logic, extended `ShippingIntent` model, and Pydantic request/response schemas for the interactive flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-interactive-shipping/08-RESEARCH.md

@src/orchestrator/models/intent.py
@src/api/schemas.py
@src/services/ups_payload_builder.py
@src/db/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create interactive shipping service with deterministic schema generator</name>
  <files>src/services/interactive_shipping.py</files>
  <action>
Create `src/services/interactive_shipping.py` with the following:

1. **UPS_REQUIRED_FIELDS dict** - Flat field definitions for all UPS-required domestic shipment fields:
   - `ship_to_name`: string, title "Recipient Name", maxLength 35
   - `ship_to_address1`: string, title "Street Address", maxLength 35
   - `ship_to_city`: string, title "City", maxLength 30
   - `ship_to_state`: string, title "State", pattern `^[A-Z]{2}$`, maxLength 2
   - `ship_to_postal_code`: string, title "ZIP Code", pattern `^\d{5}(-\d{4})?$`
   - `weight`: number, title "Package Weight (lbs)", minimum 0.1, maximum 150
   - `service_code`: string with oneOf for UPS services (03=Ground, 02=2nd Day Air, 01=Next Day Air, 12=3 Day Select, 13=Next Day Air Saver), default "03"

2. **UPS_DEFAULT_FIELDS dict** - Fields with automatic defaults (not shown in form unless user provided):
   - `ship_to_country`: "US"
   - `packaging_type`: "02" (Customer Supplied Package)

3. **UPS_OPTIONAL_FIELDS dict** - Optional fields user may provide:
   - `ship_to_address2`: string, title "Address Line 2", maxLength 35
   - `ship_to_phone`: string, title "Phone Number"
   - `ship_to_company`: string, title "Company Name", maxLength 35
   - `length`: number, title "Length (inches)", minimum 1
   - `width`: number, title "Width (inches)", minimum 1
   - `height`: number, title "Height (inches)", minimum 1

4. **`generate_shipping_form_schema(initial_data: dict[str, Any]) -> tuple[dict[str, Any], str]`**:
   - Iterates UPS_REQUIRED_FIELDS. For each field: if present and non-empty in `initial_data`, set it as `default` in the schema copy. Always add to `required` list.
   - Iterates UPS_OPTIONAL_FIELDS. For each: if present in `initial_data`, set as `default`.
   - Returns tuple of (flat JSON Schema dict, human-readable message string).
   - Message varies: "All required fields found. Please confirm the details below:" when all required fields provided, else "Found {N} of {M} required fields. Please fill in the remaining details:".
   - Schema must be MCP-compliant: `{"type": "object", "properties": {...}, "required": [...]}` with only primitive types (string, number, boolean) and oneOf for enums. No nested objects.

5. **`create_interactive_job_row(db: Session, form_data: dict[str, Any]) -> tuple[Job, JobRow]`**:
   - Creates a Job with `name="Interactive Shipment: {ship_to_name}"`, `original_command="Interactive shipment to {ship_to_name}"`, `status=JobStatus.pending.value`.
   - Applies UPS_DEFAULT_FIELDS for any missing defaults (country, packaging_type).
   - Creates a single JobRow with row_number=1, status=RowStatus.pending.value, cost_cents=0, order_data=JSON of merged form_data + defaults.
   - Computes row_checksum via SHA-256 of sorted JSON keys (same pattern as CommandProcessor).
   - Returns the (Job, JobRow) tuple.
   - Imports: `from src.db.models import Job, JobRow, JobStatus, RowStatus`

Include proper docstrings for all functions. Include `__all__` export list.

IMPORTANT: Do NOT use LLM calls anywhere in this service. Everything is deterministic Python code. This is the core of requirement INT-07.
  </action>
  <verify>
    Run: `python -c "from src.services.interactive_shipping import generate_shipping_form_schema, UPS_REQUIRED_FIELDS; schema, msg = generate_shipping_form_schema({'ship_to_name': 'John', 'weight': 5.0}); print(len(schema['required']), msg); assert schema['type'] == 'object'; assert 'ship_to_name' in schema['properties']; assert schema['properties']['ship_to_name'].get('default') == 'John'"` succeeds.
  </verify>
  <done>
    - `generate_shipping_form_schema()` returns valid flat JSON Schema with correct required fields
    - Pre-filled values appear as `default` in schema properties
    - `create_interactive_job_row()` creates Job + single JobRow from form data
    - No LLM imports or calls anywhere in the file
    - All UPS-required fields for domestic shipment are covered
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend ShippingIntent model and add API schemas</name>
  <files>src/orchestrator/models/intent.py, src/api/schemas.py</files>
  <action>
**In `src/orchestrator/models/intent.py`:**

Add two new fields to the `ShippingIntent` class:

```python
is_interactive: bool = Field(
    default=False,
    description="True when command is a direct ship-to instruction without data source reference",
)
initial_data: dict | None = Field(
    default=None,
    description="Partial shipment data extracted from NL command for interactive mode",
)
```

These are additive fields with defaults, so existing code that creates ShippingIntent without them will continue to work unchanged.

**In `src/api/schemas.py`:**

Add the following new schemas at the end of the file (before any `__all__` if present):

1. **`ElicitationResponse(BaseModel)`**:
   - `action: Literal["elicit"] = "elicit"` - Always "elicit" for this response type
   - `message: str` - Human-readable message about what fields are needed
   - `schema_: dict = Field(..., alias="schema", description="MCP-compliant flat JSON Schema for missing fields")` - Use alias "schema" since `schema` is a reserved Pydantic method name. Use `model_config = ConfigDict(populate_by_name=True)`.
   - `initial_data: dict = Field(default_factory=dict, description="Pre-filled values from NL command")`
   - `job_id: str | None = None` - Optional job ID if one was created

2. **`InteractiveShipmentRequest(BaseModel)`**:
   - `form_data: dict = Field(..., description="User-filled form data matching the elicitation schema")`
   - `job_id: str | None = Field(None, description="Existing job ID if resuming")`

3. **`InteractiveCommandResponse(BaseModel)`**:
   - `action: str = Field(..., description="Response action type: 'elicit' or 'preview'")`
   - `job_id: str | None = None`
   - `message: str | None = None`
   - `schema_: dict | None = Field(None, alias="schema")`
   - `initial_data: dict | None = None`
   - Add `model_config = ConfigDict(populate_by_name=True)`

IMPORTANT: For the `schema` field alias, use Pydantic v2's `ConfigDict(populate_by_name=True)` pattern to allow both `schema_` (Python) and `schema` (JSON) access. Import `ConfigDict` from pydantic if not already imported.

Do NOT modify any existing schemas. These are purely additive.
  </action>
  <verify>
    Run: `python -c "from src.orchestrator.models.intent import ShippingIntent; i = ShippingIntent(action='ship', is_interactive=True, initial_data={'weight': 5}); print(i.is_interactive, i.initial_data)"` succeeds with `True {'weight': 5}`.
    Run: `python -c "from src.api.schemas import ElicitationResponse, InteractiveShipmentRequest; e = ElicitationResponse(message='test', schema={'type': 'object', 'properties': {}, 'required': []}); print(e.action, e.model_dump(by_alias=True)['schema'])"` succeeds.
  </verify>
  <done>
    - ShippingIntent has `is_interactive` (default False) and `initial_data` (default None) fields
    - Existing ShippingIntent usage is unaffected (backward compatible)
    - ElicitationResponse, InteractiveShipmentRequest, InteractiveCommandResponse schemas exist
    - All schemas serialize correctly with proper field aliases
  </done>
</task>

</tasks>

<verification>
1. `python -c "from src.services.interactive_shipping import generate_shipping_form_schema"` - Import succeeds
2. `python -c "from src.orchestrator.models.intent import ShippingIntent; i = ShippingIntent(action='ship'); assert i.is_interactive == False"` - Backward compat
3. `python -c "from src.api.schemas import ElicitationResponse"` - Import succeeds
4. `pytest tests/ -k "intent" --no-header -q 2>/dev/null | tail -3` - Existing intent tests still pass
</verification>

<success_criteria>
- generate_shipping_form_schema() produces MCP-compliant flat JSON Schema
- Schema correctly identifies missing vs provided fields
- ShippingIntent model extended without breaking existing code
- API schemas define clean request/response contracts for interactive flow
- Zero LLM calls in the interactive shipping service
</success_criteria>

<output>
After completion, create `.planning/phases/08-interactive-shipping/08-01-SUMMARY.md`
</output>
