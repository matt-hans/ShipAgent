---
phase: 08-interactive-shipping
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - frontend/src/components/DynamicFormRenderer.tsx
  - frontend/src/components/CommandCenter.tsx
  - frontend/src/components/command-center/presentation.tsx
  - frontend/src/types/api.ts
  - frontend/src/lib/api.ts
  - frontend/src/hooks/useAppState.tsx
autonomous: false

must_haves:
  truths:
    - "User sees dynamic form inline in chat when agent emits elicitation_form event"
    - "Form renders correct input types: text for strings, number for weight, dropdown for service_code (oneOf)"
    - "Pre-filled fields from NL extraction are shown as editable defaults"
    - "User can submit form which POSTs to /api/v1/interactive/submit and displays preview"
    - "User can cancel form which dismisses it"
    - "Interactive Ship button in input area starts guided flow without typing"
    - "Input field is NOT disabled when no data source is connected (allows interactive commands)"
  artifacts:
    - path: "frontend/src/components/DynamicFormRenderer.tsx"
      provides: "React component rendering flat JSON Schema as form with field-type-aware inputs"
      min_lines: 100
    - path: "frontend/src/components/CommandCenter.tsx"
      provides: "Updated chat UI handling elicitation_form events and Interactive Ship button"
      contains: "elicitation_form"
    - path: "frontend/src/types/api.ts"
      provides: "ElicitationFormSchema type + elicitation_form AgentEventType"
      contains: "elicitation_form"
    - path: "frontend/src/lib/api.ts"
      provides: "submitInteractiveForm() API client function"
      contains: "interactive/submit"
  key_links:
    - from: "frontend/src/components/CommandCenter.tsx"
      to: "frontend/src/components/DynamicFormRenderer.tsx"
      via: "import and render DynamicFormRenderer when elicitation_form event received"
      pattern: "DynamicFormRenderer"
    - from: "frontend/src/components/DynamicFormRenderer.tsx"
      to: "frontend/src/lib/api.ts"
      via: "calls submitInteractiveForm() on form submit"
      pattern: "submitInteractiveForm"
    - from: "frontend/src/lib/api.ts"
      to: "/api/v1/interactive/submit"
      via: "POST request"
      pattern: "interactive/submit"
---

<objective>
Build the frontend components for interactive shipping: a DynamicFormRenderer component that renders flat JSON Schema as inline chat forms, integrate it into CommandCenter to handle elicitation_form SSE events, add an "Interactive Ship" button, and add API client + TypeScript types.

Purpose: Enable the user to see and fill shipping forms inline in the chat, submit them to create shipments without a data source file, and use a quick-start button for guided creation.

Output: New `DynamicFormRenderer.tsx`, updated `CommandCenter.tsx`, `presentation.tsx`, `api.ts`, `types/api.ts`, `useAppState.tsx`
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@frontend/src/components/CommandCenter.tsx
@frontend/src/components/command-center/presentation.tsx
@frontend/src/types/api.ts
@frontend/src/lib/api.ts
@frontend/src/hooks/useAppState.tsx
@frontend/src/hooks/useConversation.ts
@.planning/phases/08-interactive-shipping/08-01-SUMMARY.md
@.planning/phases/08-interactive-shipping/08-02-SUMMARY.md
@.planning/phases/08-interactive-shipping/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TypeScript types and API client for interactive shipping</name>
  <files>frontend/src/types/api.ts, frontend/src/lib/api.ts, frontend/src/hooks/useAppState.tsx</files>
  <action>
**In `frontend/src/types/api.ts`**:

1. Add `'elicitation_form'` to the `AgentEventType` union type (alongside existing `'preview_ready'`, `'agent_message'`, etc.).

2. Add new types:
   ```typescript
   /** JSON Schema property definition for a single form field. */
   export interface FormFieldSchema {
     type: 'string' | 'number';
     title: string;
     default?: string | number;
     pattern?: string;
     minimum?: number;
     maximum?: number;
     maxLength?: number;
     oneOf?: Array<{ const: string; title: string }>;
   }

   /** Flat JSON Schema for elicitation form (MCP-compliant). */
   export interface ElicitationFormSchema {
     type: 'object';
     properties: Record<string, FormFieldSchema>;
     required: string[];
     prefilled: Record<string, string | number>;
   }

   /** Request body for interactive form submission. */
   export interface InteractiveSubmitRequest {
     ship_to_name: string;
     ship_to_address1: string;
     ship_to_city: string;
     ship_to_state: string;
     ship_to_postal_code: string;
     weight: number;
     service_code?: string;
     ship_to_country?: string;
     ship_to_address2?: string;
     ship_to_phone?: string;
     ship_to_company?: string;
     length?: number;
     width?: number;
     height?: number;
     packaging_type?: string;
     command?: string;
     session_id?: string;
   }

   /** Response from interactive form submission. */
   export interface InteractiveSubmitResponse {
     job_id: string;
     status: string;
     total_estimated_cost_cents: number;
     preview_rows: Array<Record<string, unknown>>;
     total_rows: number;
   }
   ```

**In `frontend/src/lib/api.ts`**:

Add a new function after the conversation API section:

```typescript
// === Interactive Shipping API ===

import type {
  InteractiveSubmitRequest,
  InteractiveSubmitResponse,
} from '@/types/api';

/**
 * Submit an interactive shipping form.
 *
 * Posts completed form data to the interactive endpoint,
 * which creates a single-row job and returns preview data.
 *
 * @param data - Shipping form data with all required fields.
 * @returns Preview result with job_id, cost estimate, and row preview.
 */
export async function submitInteractiveForm(
  data: InteractiveSubmitRequest
): Promise<InteractiveSubmitResponse> {
  const response = await fetch(`${API_BASE}/interactive/submit`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  return parseResponse<InteractiveSubmitResponse>(response);
}
```

**In `frontend/src/hooks/useAppState.tsx`**:

1. Add `'interactive_form'` to the `metadata.action` type union in the `ConversationMessage` interface, alongside existing `'preview' | 'execute' | 'complete' | 'error' | 'elicit'`. Change it to: `'preview' | 'execute' | 'complete' | 'error' | 'elicit' | 'interactive_form'`.

2. Add an optional `formSchema` field to the metadata:
   ```typescript
   formSchema?: ElicitationFormSchema;
   ```
   Import `ElicitationFormSchema` from `@/types/api`.
  </action>
  <verify>
Run: `cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npx tsc --noEmit 2>&1 | head -20` -- should have no new type errors related to interactive shipping types.
  </verify>
  <done>TypeScript types for ElicitationFormSchema, InteractiveSubmitRequest, InteractiveSubmitResponse exist. API client function submitInteractiveForm() calls POST /api/v1/interactive/submit. AgentEventType includes 'elicitation_form'. ConversationMessage metadata supports formSchema.</done>
</task>

<task type="auto">
  <name>Task 2: Create DynamicFormRenderer component</name>
  <files>frontend/src/components/DynamicFormRenderer.tsx</files>
  <action>
Create `frontend/src/components/DynamicFormRenderer.tsx`:

A React component that renders a flat JSON Schema as an inline chat form card, following the same visual style as PreviewCard.

**Props interface:**
```typescript
interface DynamicFormRendererProps {
  schema: ElicitationFormSchema;
  command: string;
  onSubmit: (formData: Record<string, string | number>) => void;
  onCancel: () => void;
  isSubmitting?: boolean;
}
```

**Implementation:**

1. **State**: `formValues` as `Record<string, string | number>`, initialized from `schema.prefilled` merged with `schema.properties` defaults.

2. **Field rendering logic** (iterate `Object.entries(schema.properties)`):
   - If property has `oneOf` array: render a `<select>` dropdown with options from `oneOf[].title` as labels and `oneOf[].const` as values
   - If `type === 'number'`: render `<input type="number" step="0.1" min={prop.minimum} max={prop.maximum} />`
   - If `type === 'string'` with `maxLength`: render `<input type="text" maxLength={prop.maxLength} />`
   - If `type === 'string'` (default): render `<input type="text" />`
   - Mark required fields with a red asterisk (`*`) in the label

3. **Form layout**:
   - Wrapped in a card matching `card-premium` class pattern
   - Header: Package icon + "Complete Shipment Details" title + description showing prefilled count
   - Two-column grid for address fields (city + state on same row, zip + country on same row)
   - Single column for name, address, phone, company
   - Weight and dimensions in a row
   - Service selection as its own row
   - Footer: "Ship" button (btn-primary) and "Cancel" button (btn-secondary)

4. **Validation on submit**:
   - Check all `schema.required` fields have non-empty values
   - Highlight missing required fields with red border
   - Prevent submission if validation fails

5. **Styling**: Use existing CSS classes from the project:
   - `card-premium` for the outer card
   - Standard Tailwind input classes matching existing inputs in the project
   - `btn-primary` for Ship button, `btn-secondary` for Cancel
   - `animate-fade-in-up` for entry animation

6. **Pre-filled field indication**: Fields that come from NL extraction (exist in `schema.prefilled`) should have a subtle indicator -- a small "(from your command)" text below the input in muted color.

Import `ElicitationFormSchema` from `@/types/api`. Use only inline SVG icons or icons already defined in presentation.tsx (PackageIcon). No new icon libraries.
  </action>
  <verify>
Run: `cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npx tsc --noEmit 2>&1 | head -20` -- no type errors.
  </verify>
  <done>DynamicFormRenderer component exists, renders flat JSON Schema as inline form with text/number/select inputs, validates required fields, shows prefilled values, and calls onSubmit/onCancel callbacks.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate DynamicFormRenderer into CommandCenter + add Interactive Ship button</name>
  <files>frontend/src/components/CommandCenter.tsx, frontend/src/components/command-center/presentation.tsx</files>
  <action>
**In `frontend/src/components/CommandCenter.tsx`**:

1. **Import DynamicFormRenderer**: `import { DynamicFormRenderer } from '@/components/DynamicFormRenderer';`
   Also import: `import { submitInteractiveForm } from '@/lib/api';`
   Also import: `import type { ElicitationFormSchema, BatchPreview } from '@/types/api';`

2. **Add state for interactive form**:
   ```typescript
   const [activeForm, setActiveForm] = React.useState<{
     schema: ElicitationFormSchema;
     command: string;
   } | null>(null);
   const [isFormSubmitting, setIsFormSubmitting] = React.useState(false);
   ```

3. **Handle `elicitation_form` SSE event** in the event processing useEffect (the one that processes `conv.events`):
   Add a new `else if` branch after the `preview_ready` handler:
   ```typescript
   } else if (event.type === 'elicitation_form') {
     const schema = event.data.schema as unknown as ElicitationFormSchema;
     const command = (event.data.command as string) || '';
     setActiveForm({ schema, command });
     addMessage({
       role: 'system',
       content: 'Please fill in the shipping details below:',
       metadata: { action: 'interactive_form' },
     });
     suppressNextMessageRef.current = true;
   }
   ```

4. **Handle form submission**:
   ```typescript
   const handleFormSubmit = async (formData: Record<string, string | number>) => {
     if (!activeForm) return;
     setIsFormSubmitting(true);

     try {
       // Merge prefilled data with form data
       const mergedData = { ...activeForm.schema.prefilled, ...formData };

       const result = await submitInteractiveForm({
         ...mergedData as any,
         command: activeForm.command,
         session_id: conv.sessionId || undefined,
       });

       // Convert to BatchPreview format for existing PreviewCard
       const previewData: BatchPreview = {
         job_id: result.job_id,
         total_rows: result.total_rows,
         preview_rows: result.preview_rows.map((row: any, i: number) => ({
           row_number: i + 1,
           recipient_name: (mergedData as any).ship_to_name || 'Unknown',
           city_state: `${(mergedData as any).ship_to_city || ''}, ${(mergedData as any).ship_to_state || ''}`,
           service: (mergedData as any).service_code || '03',
           estimated_cost_cents: row.cost_cents || row.estimated_cost_cents || 0,
           warnings: row.warnings || [],
         })),
         additional_rows: 0,
         total_estimated_cost_cents: result.total_estimated_cost_cents,
         rows_with_warnings: 0,
       };

       setActiveForm(null);
       setPreview(previewData);
       setCurrentJobId(result.job_id);
       refreshJobList();
       addMessage({
         role: 'system',
         content: 'Preview ready -- please review and click Confirm or Cancel.',
       });
     } catch (err) {
       addMessage({
         role: 'system',
         content: `Error: ${err instanceof Error ? err.message : 'Failed to submit form'}`,
         metadata: { action: 'error' },
       });
     } finally {
       setIsFormSubmitting(false);
     }
   };

   const handleFormCancel = () => {
     setActiveForm(null);
     addMessage({
       role: 'system',
       content: 'Interactive shipment cancelled.',
     });
   };
   ```

5. **Render DynamicFormRenderer** in the messages area, after the conversation messages and before the preview card:
   ```tsx
   {/* Interactive form */}
   {activeForm && !preview && !executingJobId && (
     <div className="pl-11">
       <DynamicFormRenderer
         schema={activeForm.schema}
         command={activeForm.command}
         onSubmit={handleFormSubmit}
         onCancel={handleFormCancel}
         isSubmitting={isFormSubmitting}
       />
     </div>
   )}
   ```
   Place this BEFORE the `{/* Preview card */}` section.

6. **Unlock input for interactive mode**: The input is currently disabled when `!hasDataSource`. Change the disabled condition to allow interactive commands even without a data source:
   - Change `disabled={!hasDataSource || isProcessing || !!preview || !!executingJobId}` to:
     `disabled={isProcessing || !!preview || !!executingJobId || !!activeForm}`
   - Remove `hasDataSource` from the submit button disabled condition too.
   - Update the placeholder text logic:
     ```typescript
     placeholder={
       isProcessing
         ? 'Processing...'
         : activeForm
         ? 'Fill out the form above...'
         : !hasDataSource
         ? 'Describe a shipment or connect a data source...'
         : 'Enter a shipping command...'
     }
     ```
   - Also remove `!hasDataSource` from `handleSubmit`'s early return: change `if (!command || isProcessing || !hasDataSource) return;` to `if (!command || isProcessing) return;`

7. **Update help text** to reflect interactive mode when no data source:
   ```tsx
   <p className="text-[10px] font-mono text-slate-500 mt-1.5">
     {hasDataSource
       ? 'Describe what you want to ship in natural language'
       : 'Try "Ship a 5lb box to John Smith at 123 Main St, NY 10001" or connect a data source'} ...
   </p>
   ```

**In `frontend/src/components/command-center/presentation.tsx`**:

1. **Add InteractiveShipButton component** (exported):
   ```tsx
   export function InteractiveShipButton({ onClick }: { onClick: () => void }) {
     return (
       <button
         onClick={onClick}
         className="flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-cyan-500/30 bg-cyan-500/10 text-cyan-400 hover:bg-cyan-500/20 transition-colors"
       >
         <PackageIcon className="w-3.5 h-3.5" />
         Interactive Ship
       </button>
     );
   }
   ```

2. **Update WelcomeMessage** to include an "Interactive Ship" action button. Add the button below the existing example commands area. When clicked, it should call `onInteractiveShip` callback prop (add to WelcomeMessage props). This button uses the InteractiveShipButton component.

Then back in **CommandCenter.tsx**:

3. **Handle Interactive Ship button click**: When clicked, send a trigger message to the agent:
   ```typescript
   const handleInteractiveShip = async () => {
     const command = "I want to ship a single package interactively";
     addMessage({ role: 'user', content: command });
     await conv.sendMessage(command);
   };
   ```
   Pass `onInteractiveShip={handleInteractiveShip}` to WelcomeMessage.
  </action>
  <verify>
Run: `cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npx tsc --noEmit 2>&1 | head -30` -- no type errors.
Run: `cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build 2>&1 | tail -5` -- build succeeds.
  </verify>
  <done>DynamicFormRenderer integrated into CommandCenter, rendering inline forms on elicitation_form events. Form submission calls /api/v1/interactive/submit and feeds result into existing PreviewCard. Interactive Ship button in welcome screen and input area. Input unlocked for interactive commands even without data source.</done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with no new errors
2. `cd frontend && npm run build` succeeds
3. DynamicFormRenderer renders from flat JSON Schema with correct input types
4. CommandCenter processes elicitation_form SSE events
5. Form submission creates preview via /api/v1/interactive/submit
6. Interactive Ship button visible in welcome screen
7. Input not disabled when no data source connected
</verification>

<success_criteria>
- ElicitationFormSchema and related types exist in types/api.ts
- submitInteractiveForm() function exists in lib/api.ts
- DynamicFormRenderer renders flat JSON Schema with text/number/select inputs
- Pre-filled fields show values extracted from NL with indication text
- CommandCenter handles elicitation_form events and renders form inline in chat
- Form submission feeds into existing PreviewCard flow (confirm/cancel work unchanged)
- Interactive Ship button starts guided flow
- Chat input works without a connected data source for interactive commands
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-interactive-shipping/08-03-SUMMARY.md`
</output>
