---
phase: 06-batch-execution
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - src/orchestrator/batch/preview.py
  - src/orchestrator/batch/__init__.py
  - tests/unit/orchestrator/batch/test_preview.py
autonomous: true

must_haves:
  truths:
    - "Preview shows first 20 rows with detailed cost estimates"
    - "Remaining rows show aggregate estimate based on average"
    - "Warnings are flagged for address corrections"
    - "Preview uses rating_quote for cost estimation"
    - "Large batches (>20 rows) show summary statistics"
  artifacts:
    - path: "src/orchestrator/batch/preview.py"
      provides: "PreviewGenerator for batch cost estimation"
      min_lines: 120
      exports: ["PreviewGenerator"]
    - path: "tests/unit/orchestrator/batch/test_preview.py"
      provides: "Unit tests for preview generation"
      min_lines: 100
  key_links:
    - from: "src/orchestrator/batch/preview.py"
      to: "UPS MCP"
      via: "rating_quote tool calls"
      pattern: "rating_quote"
    - from: "src/orchestrator/batch/preview.py"
      to: "Data MCP"
      via: "get_rows_by_filter tool calls"
      pattern: "get_rows_by_filter"
---

<objective>
Implement the PreviewGenerator for batch cost estimation and preview display.

Purpose: BATCH-02 requires users to preview shipment details and total cost before execution. The PreviewGenerator fetches rate quotes for the first 20 rows (per CONTEXT.md Decision 1) and estimates remaining rows from the average.

Output: PreviewGenerator class that produces BatchPreview objects for user confirmation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-batch-execution/06-CONTEXT.md
@.planning/phases/06-batch-execution/06-RESEARCH.md

# Dependencies from Plan 02
@src/orchestrator/batch/models.py

# Template rendering from Phase 4
@src/orchestrator/nl_engine/mapping_generator.py
@src/orchestrator/filters/logistics.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreviewGenerator class</name>
  <files>src/orchestrator/batch/preview.py</files>
  <action>
Create `src/orchestrator/batch/preview.py` with the PreviewGenerator class.

```python
"""Preview generation for batch shipments.

Per CONTEXT.md Decision 1:
- Show first 20 rows in detail
- Aggregate stats for remaining rows
- Per-row cost shown plus batch total
- Flag rows with warnings
"""

from typing import Any, Callable, Awaitable
from jinja2 import Environment

from src.orchestrator.batch.models import PreviewRow, BatchPreview
from src.orchestrator.filters.logistics import create_logistics_environment


class PreviewGenerator:
    """Generates batch previews with cost estimates."""

    MAX_PREVIEW_ROWS = 20  # Per CONTEXT.md Decision 1

    def __init__(
        self,
        data_mcp_call: Callable[[str, dict], Awaitable[dict]],
        ups_mcp_call: Callable[[str, dict], Awaitable[dict]],
        jinja_env: Environment | None = None,
    ):
        """Initialize the preview generator.

        Args:
            data_mcp_call: Function to call Data MCP tools (tool_name, args) -> result
            ups_mcp_call: Function to call UPS MCP tools (tool_name, args) -> result
            jinja_env: Optional Jinja2 environment (defaults to logistics env)
        """
        self._data_mcp = data_mcp_call
        self._ups_mcp = ups_mcp_call
        self._jinja_env = jinja_env or create_logistics_environment()

    async def generate_preview(
        self,
        job_id: str,
        filter_clause: str,
        mapping_template: str,
        shipper_info: dict[str, Any],
    ) -> BatchPreview:
        """Generate preview with cost estimates.

        Args:
            job_id: Job ID for tracking
            filter_clause: SQL WHERE clause for filtering rows
            mapping_template: Jinja2 template string for mapping row data to UPS payload
            shipper_info: Shipper address and account info

        Returns:
            BatchPreview with detailed rows and aggregates
        """
```

Implementation details:

1. Call `data_mcp_call("get_rows_by_filter", {"where_clause": filter_clause, "limit": 20, "offset": 0})`
2. Get total_count from result
3. For each row in result["rows"]:
   a. Render template with row data: `template = self._jinja_env.from_string(mapping_template); payload = template.render(row=row["data"], shipper=shipper_info)`
   b. Parse rendered JSON
   c. Call `ups_mcp_call("rating_quote", {...})` with rendered payload
   d. Extract cost from quote["totalCharges"]["amount"]
   e. Check for warnings (address corrections in quote response)
   f. Create PreviewRow with truncated recipient_name (20 chars), city_state, service, cost, warnings

4. Calculate aggregates:
   - total_estimated = sum of preview row costs
   - If additional_rows > 0: estimate remaining as avg_cost * additional_rows
   - Count rows_with_warnings

5. Return BatchPreview

Helper methods:
- `_truncate(text: str, max_len: int) -> str`: Truncate without cutting words
- `_check_warnings(row_data: dict, quote_result: dict) -> list[str]`: Extract warnings from quote
- `_parse_cost_cents(amount: str) -> int`: Convert string amount to cents
  </action>
  <verify>
Run `python -c "from src.orchestrator.batch.preview import PreviewGenerator; print('OK')"`
  </verify>
  <done>
PreviewGenerator class exists with generate_preview method that fetches rate quotes and creates BatchPreview.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update batch package exports</name>
  <files>src/orchestrator/batch/__init__.py</files>
  <action>
Update `src/orchestrator/batch/__init__.py` to export PreviewGenerator.

Add import:
```python
from src.orchestrator.batch.preview import PreviewGenerator
```

Add to __all__:
```python
__all__ = [
    # ... existing exports
    "PreviewGenerator",
]
```
  </action>
  <verify>
Run `python -c "from src.orchestrator.batch import PreviewGenerator; print('OK')"`
  </verify>
  <done>
PreviewGenerator is exported from the batch package.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for PreviewGenerator</name>
  <files>tests/unit/orchestrator/batch/test_preview.py</files>
  <action>
Create comprehensive unit tests for PreviewGenerator.

Test setup:
- Mock data_mcp_call to return sample rows
- Mock ups_mcp_call to return sample rate quotes
- Use a simple mapping template for testing

Test cases:

1. `test_generate_preview_small_batch`:
   - 5 rows total
   - All rows get rate quotes
   - No additional_rows estimate needed

2. `test_generate_preview_large_batch`:
   - 50 rows total (only first 20 detailed)
   - additional_rows = 30
   - Estimated cost includes avg * 30

3. `test_preview_truncates_long_names`:
   - Recipient name > 20 chars is truncated

4. `test_preview_captures_warnings`:
   - Mock quote with address correction indicator
   - Verify warning appears in PreviewRow

5. `test_preview_handles_quote_error`:
   - Mock ups_mcp_call raising exception
   - Should propagate error (fail-fast)

6. `test_preview_empty_batch`:
   - 0 rows match filter
   - Return BatchPreview with empty lists

7. `test_preview_cost_calculation`:
   - Verify cost_cents conversion from string amount
   - Verify total aggregation

Use pytest fixtures for mocked MCP calls and sample data.
  </action>
  <verify>
Run `pytest tests/unit/orchestrator/batch/test_preview.py -v`
  </verify>
  <done>
All preview tests pass covering small/large batches, truncation, warnings, errors, and cost calculations.
  </done>
</task>

</tasks>

<verification>
- [ ] PreviewGenerator imports successfully
- [ ] PreviewGenerator exported from batch package
- [ ] generate_preview returns BatchPreview with correct structure
- [ ] First 20 rows get detailed quotes
- [ ] Remaining rows estimated from average
- [ ] Warnings captured from rate quote responses
- [ ] All unit tests pass
</verification>

<success_criteria>
- PreviewGenerator creates BatchPreview with first 20 rows detailed
- Large batches (>20 rows) show aggregate estimate
- Warnings flagged from quote responses
- Cost shown per-row and as batch total
- Unit tests cover all scenarios
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-execution/06-03-SUMMARY.md`
</output>
