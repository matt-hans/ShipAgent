---
phase: 06-batch-execution
plan: 06
type: execute
wave: 3
depends_on: ["06-03", "06-04", "06-05"]
files_modified:
  - src/orchestrator/agent/tools.py
  - tests/unit/orchestrator/agent/test_batch_tools.py
autonomous: true

must_haves:
  truths:
    - "batch_preview tool generates preview with cost estimates"
    - "batch_execute tool runs batch with mode support"
    - "batch_set_mode tool changes execution mode"
    - "batch_resume tool handles crash recovery"
    - "All tools return MCP-compatible responses"
  artifacts:
    - path: "src/orchestrator/agent/tools.py"
      provides: "New batch orchestrator tools"
      exports: ["batch_preview_tool", "batch_execute_tool", "batch_set_mode_tool", "batch_resume_tool"]
    - path: "tests/unit/orchestrator/agent/test_batch_tools.py"
      provides: "Unit tests for batch tools"
      min_lines: 100
  key_links:
    - from: "src/orchestrator/agent/tools.py"
      to: "src/orchestrator/batch/preview.py"
      via: "PreviewGenerator usage"
      pattern: "PreviewGenerator"
    - from: "src/orchestrator/agent/tools.py"
      to: "src/orchestrator/batch/executor.py"
      via: "BatchExecutor usage"
      pattern: "BatchExecutor"
---

<objective>
Add batch execution tools to the orchestrator agent for preview, execute, mode switching, and recovery.

Purpose: The OrchestrationAgent needs tools to expose batch functionality to Claude. This plan adds tools for BATCH-02 (preview), BATCH-03 (execute), BATCH-04 (mode toggle), and crash recovery.

Output: Four new orchestrator tools registered alongside existing tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-batch-execution/06-CONTEXT.md
@.planning/phases/06-batch-execution/06-RESEARCH.md

# Existing tools pattern
@src/orchestrator/agent/tools.py
@src/orchestrator/agent/client.py

# Batch components
@src/orchestrator/batch/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch tools to orchestrator</name>
  <files>src/orchestrator/agent/tools.py</files>
  <action>
Add four new batch tools to `src/orchestrator/agent/tools.py` following the existing pattern.

1. Add imports at top of file:
```python
from src.orchestrator.batch import (
    ExecutionMode,
    SessionModeManager,
    PreviewGenerator,
    BatchExecutor,
    check_interrupted_jobs,
    get_recovery_prompt,
    handle_recovery_choice,
    RecoveryChoice,
)
```

2. Add module-level session mode manager (singleton like _engine):
```python
_mode_manager: SessionModeManager | None = None

def _get_mode_manager() -> SessionModeManager:
    global _mode_manager
    if _mode_manager is None:
        _mode_manager = SessionModeManager()
    return _mode_manager
```

3. Implement `batch_preview_tool`:
```python
async def batch_preview_tool(args: dict[str, Any]) -> dict[str, Any]:
    """Generate batch preview with cost estimates.

    Args:
        args: Dict with:
            - job_id (str): UUID of the job
            - filter_clause (str): SQL WHERE clause for row selection
            - mapping_template (str): Jinja2 template for payload
            - shipper_info (dict): Shipper address and account

    Returns:
        MCP response with BatchPreview as JSON
    """
```
- Create PreviewGenerator with MCP call wrappers (placeholder - actual MCP calls come from agent)
- Call generate_preview
- Return JSON response with preview details

4. Implement `batch_execute_tool`:
```python
async def batch_execute_tool(args: dict[str, Any]) -> dict[str, Any]:
    """Execute batch shipments.

    If mode is CONFIRM, preview must be approved first.
    If mode is AUTO, executes immediately.

    Args:
        args: Dict with:
            - job_id (str): UUID of the job
            - mapping_template (str): Jinja2 template
            - shipper_info (dict): Shipper address
            - approved (bool, optional): True if preview approved

    Returns:
        MCP response with BatchResult as JSON
    """
```
- Check mode via _get_mode_manager()
- If CONFIRM mode and not approved, return error "Preview approval required"
- Lock mode during execution
- Create BatchExecutor, run execute
- Unlock mode after completion
- Return BatchResult

5. Implement `batch_set_mode_tool`:
```python
async def batch_set_mode_tool(args: dict[str, Any]) -> dict[str, Any]:
    """Set execution mode for this session.

    Args:
        args: Dict with:
            - mode (str): "confirm" or "auto"

    Returns:
        MCP response with new mode
    """
```
- Parse mode string to ExecutionMode
- Call _get_mode_manager().set_mode()
- Handle ValueError if locked

6. Implement `batch_resume_tool`:
```python
async def batch_resume_tool(args: dict[str, Any]) -> dict[str, Any]:
    """Check for and handle interrupted jobs.

    Args:
        args: Dict with:
            - choice (str, optional): "resume", "restart", or "cancel"

    Returns:
        MCP response with recovery info or action result
    """
```
- If no choice: call check_interrupted_jobs, return prompt if found
- If choice: call handle_recovery_choice

7. Add schema definitions:
```python
BATCH_PREVIEW_SCHEMA = {
    "job_id": {"type": "string", "description": "UUID of the job"},
    "filter_clause": {"type": "string", "description": "SQL WHERE clause"},
    "mapping_template": {"type": "string", "description": "Jinja2 template"},
    "shipper_info": {"type": "object", "description": "Shipper address and account"},
}

BATCH_EXECUTE_SCHEMA = {
    "job_id": {"type": "string", "description": "UUID of the job"},
    "mapping_template": {"type": "string", "description": "Jinja2 template"},
    "shipper_info": {"type": "object", "description": "Shipper address"},
    "approved": {"type": "boolean", "description": "True if preview approved"},
}

BATCH_SET_MODE_SCHEMA = {
    "mode": {"type": "string", "description": "confirm or auto"},
}

BATCH_RESUME_SCHEMA = {
    "choice": {"type": "string", "description": "resume, restart, or cancel"},
}
```

8. Update `get_orchestrator_tools()` to include new tools.

9. Update `list_tools_tool` to include batch tools in the orchestrator namespace.
  </action>
  <verify>
Run `python -c "from src.orchestrator.agent.tools import batch_preview_tool, batch_execute_tool, batch_set_mode_tool, batch_resume_tool; print('OK')"`
  </verify>
  <done>
Four batch tools implemented and registered in get_orchestrator_tools().
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for batch tools</name>
  <files>tests/unit/orchestrator/agent/test_batch_tools.py</files>
  <action>
Create unit tests for the new batch tools.

Test setup:
- Mock JobService and AuditService
- Mock MCP call functions
- Reset mode manager between tests

Test cases:

1. `test_batch_preview_returns_preview`:
   - Mock data and UPS MCP calls
   - Verify returns BatchPreview JSON

2. `test_batch_execute_confirm_requires_approval`:
   - Mode is CONFIRM, approved=False
   - Returns error about approval required

3. `test_batch_execute_confirm_with_approval`:
   - Mode is CONFIRM, approved=True
   - Executes successfully

4. `test_batch_execute_auto_no_approval_needed`:
   - Mode is AUTO
   - Executes without approval

5. `test_batch_execute_locks_mode`:
   - Start execution
   - Attempt to change mode
   - Should fail with locked error

6. `test_batch_set_mode_confirm`:
   - Set mode to confirm
   - Verify mode changed

7. `test_batch_set_mode_auto`:
   - Set mode to auto
   - Verify mode changed

8. `test_batch_set_mode_locked`:
   - Lock mode manager
   - Attempt set_mode
   - Should return error

9. `test_batch_resume_no_interrupted`:
   - No jobs in running state
   - Returns "no interrupted jobs"

10. `test_batch_resume_shows_prompt`:
    - Job in running state
    - Returns recovery prompt

11. `test_batch_resume_handles_choice`:
    - Pass choice="resume"
    - Returns action result

Use pytest fixtures and AsyncMock.
  </action>
  <verify>
Run `pytest tests/unit/orchestrator/agent/test_batch_tools.py -v`
  </verify>
  <done>
All batch tool tests pass covering preview, execute with modes, mode switching, and recovery.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update __all__ exports</name>
  <files>src/orchestrator/agent/tools.py</files>
  <action>
Update the `__all__` list in `src/orchestrator/agent/tools.py` to include new exports:

```python
__all__ = [
    # Existing exports
    "process_command_tool",
    "get_job_status_tool",
    "list_tools_tool",
    "get_orchestrator_tools",
    "PROCESS_COMMAND_SCHEMA",
    "GET_JOB_STATUS_SCHEMA",
    "LIST_TOOLS_SCHEMA",
    # New batch exports
    "batch_preview_tool",
    "batch_execute_tool",
    "batch_set_mode_tool",
    "batch_resume_tool",
    "BATCH_PREVIEW_SCHEMA",
    "BATCH_EXECUTE_SCHEMA",
    "BATCH_SET_MODE_SCHEMA",
    "BATCH_RESUME_SCHEMA",
]
```
  </action>
  <verify>
Run `python -c "from src.orchestrator.agent.tools import batch_preview_tool, BATCH_PREVIEW_SCHEMA; print('OK')"`
  </verify>
  <done>
All new batch tools and schemas are exported from the tools module.
  </done>
</task>

</tasks>

<verification>
- [ ] All four batch tools import successfully
- [ ] batch_preview_tool returns BatchPreview as JSON
- [ ] batch_execute_tool respects mode and approval
- [ ] batch_set_mode_tool changes session mode
- [ ] batch_resume_tool handles recovery flow
- [ ] Tools registered in get_orchestrator_tools()
- [ ] list_tools includes batch tools
- [ ] All unit tests pass
</verification>

<success_criteria>
- batch_preview generates cost estimates (BATCH-02)
- batch_execute runs with mode support (BATCH-03)
- batch_set_mode toggles between confirm/auto (BATCH-04)
- batch_resume handles crash recovery (BATCH-06)
- All tools follow MCP response format
- Unit tests cover all tool behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-batch-execution/06-06-SUMMARY.md`
</output>
