---
phase: 07-web-interface
plan: 05
type: execute
wave: 3
depends_on: ["07-03", "07-04"]
files_modified:
  - frontend/src/components/LabelPreview.tsx
  - frontend/src/components/LabelDownloadButton.tsx
  - frontend/src/components/CompletionSummary.tsx
  - frontend/src/pages/Dashboard.tsx
autonomous: true

must_haves:
  truths:
    - "User can click download button per row to get individual PDF label"
    - "User can preview label in modal before downloading"
    - "User can download all labels as ZIP with single click"
    - "Completion summary shows label download options"
  artifacts:
    - path: "frontend/src/components/LabelPreview.tsx"
      provides: "Modal PDF preview component"
      min_lines: 40
    - path: "frontend/src/components/LabelDownloadButton.tsx"
      provides: "Individual label download button"
      min_lines: 20
    - path: "frontend/src/components/CompletionSummary.tsx"
      provides: "Completion screen with label downloads"
      min_lines: 50
  key_links:
    - from: "frontend/src/components/LabelPreview.tsx"
      to: "react-pdf"
      via: "Document import"
      pattern: "import.*from.*react-pdf"
    - from: "frontend/src/components/CompletionSummary.tsx"
      to: "frontend/src/components/LabelDownloadButton.tsx"
      via: "component import"
      pattern: "import.*LabelDownloadButton"
---

<critical_instruction>
## MANDATORY: Use Frontend Design Skill

**Before implementing ANY UI components, visual elements, or user-facing code, you MUST invoke the `@frontend-design` skill using the Skill tool.**

This applies to:
- All React components
- All CSS/styling decisions
- Layout and spacing
- Color choices and visual hierarchy
- Interactive states (hover, focus, loading, error)
- Typography and iconography

**How to invoke:** Use the Skill tool with `skill: "frontend-design"` before writing any frontend code.

This is NON-NEGOTIABLE. The goal is a distinctive, high-quality UI that avoids generic AI aesthetics.
</critical_instruction>

<objective>
Build label preview modal and download functionality for completed shipments.

Purpose: Enables users to view and download shipping labels after batch completion.
Output: Label preview modal with in-browser PDF display, individual downloads, and bulk ZIP download.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-web-interface/07-CONTEXT.md
@.planning/phases/07-web-interface/07-RESEARCH.md
@.planning/phases/07-web-interface/07-01-SUMMARY.md
@.planning/phases/07-web-interface/07-02-SUMMARY.md
@.planning/phases/07-web-interface/07-03-SUMMARY.md
@.planning/phases/07-web-interface/07-04-SUMMARY.md
</context>

<design_note>
When implementing React components, leverage @frontend-design skill for high-quality UI design.
Per CONTEXT.md Decision 4: Download button per row, ZIP for bulk, modal preview.
</design_note>

<tasks>

<task type="auto">
  <name>Task 1: Install react-pdf and create LabelPreview component</name>
  <files>
    frontend/package.json
    frontend/src/components/LabelPreview.tsx
  </files>
  <action>
    1. Install react-pdf and pdfjs-dist:
       - npm install react-pdf pdfjs-dist

    2. Create LabelPreview.tsx:
       - Props: trackingNumber: string, isOpen: boolean, onClose()
       - Uses shadcn/ui Dialog component for modal
       - Renders PDF using react-pdf Document and Page components
       - Configure pdf.js worker per 07-RESEARCH.md Pitfall 2:
         ```typescript
         pdfjs.GlobalWorkerOptions.workerSrc = new URL(
           'pdfjs-dist/build/pdf.worker.min.mjs',
           import.meta.url,
         ).toString();
         ```
       - Loading state while PDF loads
       - Error state if PDF fails to load
       - Download button in modal footer
       - PDF source: /api/v1/labels/{trackingNumber}

    3. Modal features:
       - Close on backdrop click
       - Close on Escape key
       - Zoom controls (optional, nice-to-have)
       - Fits label to modal width
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
  </verify>
  <done>
    LabelPreview displays PDF in modal with download option
  </done>
</task>

<task type="auto">
  <name>Task 2: Create label download button and completion summary</name>
  <files>
    frontend/src/components/LabelDownloadButton.tsx
    frontend/src/components/CompletionSummary.tsx
  </files>
  <action>
    1. Create LabelDownloadButton.tsx:
       - Props: trackingNumber: string, variant: 'icon' | 'text'
       - Icon variant: Download icon button (for table rows)
       - Text variant: "Download Label" button
       - Uses anchor tag with download attribute
       - href: /api/v1/labels/{trackingNumber}
       - Opens LabelPreview on click with shift key (optional preview)

    2. Create CompletionSummary.tsx:
       - Props: jobId: string, totalRows: number, successfulRows: number, totalCostCents: number
       - Displays completion message with stats:
         - "Batch Complete!"
         - "X shipments processed successfully"
         - "Total cost: $Y.YY"
       - Download options section:
         - "Download All Labels" button -> GET /api/v1/jobs/{jobId}/labels/zip
         - List of individual labels with preview/download buttons
       - "Start New Batch" button to reset workflow
       - Fetches job rows to show label list

    3. Styling:
       - Celebratory completion state (subtle success indication)
       - Clear hierarchy between bulk and individual downloads
       - Mobile-friendly layout
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
  </verify>
  <done>
    LabelDownloadButton provides per-row downloads; CompletionSummary shows all download options
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate label components into Dashboard</name>
  <files>
    frontend/src/pages/Dashboard.tsx
    frontend/src/components/RowStatusTable.tsx
  </files>
  <action>
    1. Update Dashboard.tsx 'complete' phase:
       - Render CompletionSummary with job data
       - Pass totalRows, successfulRows, totalCostCents from final job state
       - Handle "Start New Batch" to reset to 'input' phase

    2. Update RowStatusTable.tsx:
       - Add LabelDownloadButton to each completed row
       - Only show download button when tracking_number exists
       - Add preview button that opens LabelPreview modal

    3. Add label preview modal state to Dashboard:
       - selectedTrackingNumber: string | null
       - LabelPreview renders when selectedTrackingNumber is set
       - Pass to RowStatusTable and CompletionSummary

    4. Handle bulk download:
       - "Download All" triggers window.location to ZIP endpoint
       - Or use anchor tag with download attribute
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
  </verify>
  <done>
    Dashboard shows completion summary with individual and bulk label downloads
  </done>
</task>

</tasks>

<verification>
1. Run: cd frontend && npm run build (builds without errors)
2. Run: cd frontend && npx tsc --noEmit (no TypeScript errors)
3. Manual: Complete a batch, click individual label download
4. Manual: Click preview to see PDF in modal
5. Manual: Click "Download All" to get ZIP file
6. Check: ZIP contains PDFs named by tracking number
</verification>

<success_criteria>
- [ ] react-pdf installed and configured with worker
- [ ] LabelPreview displays PDF in modal dialog
- [ ] LabelDownloadButton triggers file download
- [ ] CompletionSummary shows final stats and download options
- [ ] "Download All" button triggers ZIP download
- [ ] Individual labels downloadable from row status table
- [ ] Modal closes properly on backdrop click and Escape
- [ ] PDF loads without worker configuration errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-interface/07-05-SUMMARY.md`
</output>
