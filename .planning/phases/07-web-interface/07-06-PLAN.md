---
phase: 07-web-interface
plan: 06
type: execute
wave: 3
depends_on: ["07-03", "07-04"]
files_modified:
  - src/api/main.py
  - frontend/src/App.tsx
  - tests/api/test_commands.py
  - tests/api/test_labels.py
  - tests/api/test_progress.py
  - tests/api/test_preview.py
autonomous: false

must_haves:
  truths:
    - "FastAPI serves React build from /frontend/dist"
    - "SPA routing works (non-API routes serve index.html)"
    - "All UI requirements verified end-to-end"
    - "API tests pass for all new endpoints"
  artifacts:
    - path: "src/api/main.py"
      provides: "Static file serving and SPA fallback"
      contains: "StaticFiles"
    - path: "tests/api/test_commands.py"
      provides: "Command endpoint tests"
      min_lines: 30
    - path: "tests/api/test_labels.py"
      provides: "Label endpoint tests"
      min_lines: 30
  key_links:
    - from: "src/api/main.py"
      to: "frontend/dist"
      via: "StaticFiles mount"
      pattern: "StaticFiles.*frontend.*dist"
---

<objective>
Integrate frontend build into FastAPI, add comprehensive API tests, and verify all UI requirements.

Purpose: Complete the web interface by serving the React app from FastAPI and validating all functionality.
Output: Production-ready web interface with static file serving, SPA support, and verified requirements.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-web-interface/07-CONTEXT.md
@.planning/phases/07-web-interface/07-RESEARCH.md
@.planning/phases/07-web-interface/07-01-SUMMARY.md
@.planning/phases/07-web-interface/07-02-SUMMARY.md
@.planning/phases/07-web-interface/07-03-SUMMARY.md
@.planning/phases/07-web-interface/07-04-SUMMARY.md
@.planning/phases/07-web-interface/07-05-SUMMARY.md
@src/api/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add static file serving and SPA fallback to FastAPI</name>
  <files>
    src/api/main.py
  </files>
  <action>
    1. Update src/api/main.py to serve frontend build:
       - Import StaticFiles and FileResponse from fastapi
       - Define FRONTEND_DIR = Path(__file__).parent.parent.parent / "frontend" / "dist"
       - Only mount if FRONTEND_DIR.exists() (allows API-only mode)

    2. Mount static assets:
       - app.mount("/assets", StaticFiles(directory=FRONTEND_DIR / "assets"), name="assets")

    3. Add SPA fallback route (MUST be last):
       - @app.get("/{full_path:path}") for all non-API, non-static routes
       - Return FileResponse(FRONTEND_DIR / "index.html")
       - Skip if path starts with /api or /docs or /redoc or /openapi.json

    4. Reference 07-RESEARCH.md Pattern 2 for implementation.

    Note: API routes (/api/v1/*) must be registered BEFORE the SPA fallback.
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
    python -c "from src.api.main import app; print('OK')"
    pytest tests/api/test_jobs.py -v --tb=short
  </verify>
  <done>
    FastAPI serves React build and handles SPA routing correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Write API tests for new endpoints</name>
  <files>
    tests/api/test_commands.py
    tests/api/test_labels.py
    tests/api/test_progress.py
    tests/api/test_preview.py
  </files>
  <action>
    1. Create tests/api/test_commands.py:
       - test_submit_command_creates_job: POST /commands returns job_id
       - test_submit_command_validates_input: Empty command returns 422
       - test_get_command_history: Returns recent commands
       - test_command_history_limit: Respects limit parameter

    2. Create tests/api/test_labels.py:
       - test_get_label_returns_pdf: Returns PDF file with correct content-type
       - test_get_label_not_found: Returns 404 for missing tracking number
       - test_get_labels_zip: Returns ZIP file
       - test_get_labels_zip_empty_job: Returns empty ZIP for job with no labels
       - Use tmp_path fixture to create test PDF files

    3. Create tests/api/test_progress.py:
       - test_progress_stream_connects: SSE endpoint accepts connection
       - test_progress_fallback: GET /progress returns current state
       - Note: Full SSE testing is complex; focus on endpoint availability

    4. Create tests/api/test_preview.py:
       - test_get_preview_returns_data: Returns BatchPreviewResponse
       - test_get_preview_job_not_found: Returns 404
       - test_confirm_job_updates_status: Status changes to running
       - test_confirm_already_running: Returns appropriate error

    Use existing test patterns from tests/api/test_jobs.py.
  </action>
  <verify>
    pytest tests/api/ -v --tb=short
  </verify>
  <done>
    All new API endpoints have test coverage
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete web interface with:
    - Command input with natural language support
    - Shipment preview with cost estimates
    - Real-time progress display via SSE
    - Label preview modal and downloads
    - Bulk ZIP download
    - FastAPI serving React build
  </what-built>
  <how-to-verify>
    1. Build frontend: cd frontend && npm run build
    2. Start server: cd /Users/matthewhans/Desktop/Programming/ShipAgent && uvicorn src.api.main:app --reload
    3. Open http://localhost:8000 in browser
    4. Verify each requirement:

    UI-01 - Command Input:
    - [ ] Text input field visible
    - [ ] Can type natural language command
    - [ ] Example commands shown and clickable
    - [ ] Submit on Enter works

    UI-02 - Progress Display:
    - [ ] Progress bar appears during execution
    - [ ] Counter shows "X of Y shipments"
    - [ ] Expandable row details table
    - [ ] Error alert appears on failure

    UI-03 - Preview:
    - [ ] Preview cards show shipment details
    - [ ] Per-row cost displayed
    - [ ] Total cost in footer
    - [ ] Confirm/Cancel buttons work

    UI-04 - Labels:
    - [ ] Individual download buttons work
    - [ ] Preview modal shows PDF
    - [ ] "Download All" creates ZIP

    UI-05 - FastAPI:
    - [ ] UI loads from FastAPI (not separate server)
    - [ ] API endpoints respond at /api/v1/*
    - [ ] Refreshing page works (SPA routing)
  </how-to-verify>
  <resume-signal>
    Type "approved" if all requirements verified, or describe issues found.
  </resume-signal>
</task>

</tasks>

<verification>
1. Run: pytest tests/api/ -v (all tests pass)
2. Run: pytest tests/ -v (full test suite passes)
3. Manual: Complete end-to-end flow through web interface
4. Check: All 5 UI requirements marked verified in REQUIREMENTS.md
</verification>

<success_criteria>
- [ ] FastAPI serves frontend from /frontend/dist
- [ ] SPA routing works (refresh any page loads correctly)
- [ ] API routes still accessible at /api/v1/*
- [ ] All new API endpoints have tests
- [ ] All tests pass (pytest exit code 0)
- [ ] UI-01 verified: Command input works
- [ ] UI-02 verified: Progress display works
- [ ] UI-03 verified: Preview with costs works
- [ ] UI-04 verified: Label downloads work
- [ ] UI-05 verified: FastAPI serves UI
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-interface/07-06-SUMMARY.md`
</output>
