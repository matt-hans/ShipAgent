---
phase: 07-web-interface
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - frontend/src/components/CommandInput.tsx
  - frontend/src/components/CommandHistory.tsx
  - frontend/src/components/PreviewGrid.tsx
  - frontend/src/components/ConfirmationFooter.tsx
  - frontend/src/pages/Dashboard.tsx
  - frontend/src/App.tsx
  - src/api/routes/preview.py
  - src/api/routes/__init__.py
  - src/api/main.py
  - src/api/schemas.py
autonomous: true

must_haves:
  truths:
    - "User can type NL command in text input and submit with Enter"
    - "User sees recent commands and can click to reuse"
    - "User sees shipment preview cards with cost estimates"
    - "User can confirm or cancel batch from sticky footer"
    - "Preview data comes from backend API"
  artifacts:
    - path: "frontend/src/components/CommandInput.tsx"
      provides: "NL command text input with submit"
      min_lines: 30
    - path: "frontend/src/components/PreviewGrid.tsx"
      provides: "Grid of shipment preview cards"
      min_lines: 50
    - path: "frontend/src/components/ConfirmationFooter.tsx"
      provides: "Sticky confirm/cancel footer"
      min_lines: 20
    - path: "frontend/src/pages/Dashboard.tsx"
      provides: "Main dashboard page composing all components"
      min_lines: 80
    - path: "src/api/routes/preview.py"
      provides: "Preview and confirmation endpoints"
      exports: ["router"]
  key_links:
    - from: "frontend/src/pages/Dashboard.tsx"
      to: "frontend/src/components/CommandInput.tsx"
      via: "component import"
      pattern: "import.*CommandInput"
    - from: "frontend/src/pages/Dashboard.tsx"
      to: "frontend/src/lib/api.ts"
      via: "API calls"
      pattern: "import.*from.*lib/api"
    - from: "frontend/src/components/PreviewGrid.tsx"
      to: "frontend/src/types/api.ts"
      via: "type imports"
      pattern: "import.*PreviewRow.*from.*types/api"
---

<objective>
Build command input, preview display, and confirmation flow for the web interface.

Purpose: Enables users to enter NL commands, see shipment previews with costs, and confirm or cancel batches.
Output: Complete command-to-confirmation workflow in the React frontend with backend preview endpoint.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-web-interface/07-CONTEXT.md
@.planning/phases/07-web-interface/07-RESEARCH.md
@.planning/phases/07-web-interface/07-01-SUMMARY.md
@.planning/phases/07-web-interface/07-02-SUMMARY.md
@src/orchestrator/batch/preview.py
@src/orchestrator/batch/models.py
</context>

<design_note>
When implementing React components, leverage @frontend-design skill for high-quality UI design.
Per CONTEXT.md Decision 5: Create distinctive, polished interface avoiding generic AI aesthetics.
</design_note>

<tasks>

<task type="auto">
  <name>Task 1: Create preview API endpoint</name>
  <files>
    src/api/routes/preview.py
    src/api/schemas.py
    src/api/routes/__init__.py
    src/api/main.py
  </files>
  <action>
    1. Add preview schemas to src/api/schemas.py:
       - PreviewRowResponse: row_number, recipient_name, city_state, service, estimated_cost_cents, warnings
       - BatchPreviewResponse: job_id, total_rows, preview_rows, additional_rows, total_estimated_cost_cents, rows_with_warnings
       - ConfirmRequest: job_id
       - ConfirmResponse: status, message

    2. Create src/api/routes/preview.py:
       - GET /jobs/{job_id}/preview: Returns BatchPreviewResponse
         - Query job, get filter_clause and mapping_template from job metadata
         - For MVP, return preview data from job rows already created during command processing
         - Map JobRow data to PreviewRowResponse format
       - POST /jobs/{job_id}/confirm: Confirms batch for execution
         - Updates job status to 'running'
         - Returns confirmation status

    3. Update src/api/routes/__init__.py to export preview module

    4. Update src/api/main.py to include preview router
  </action>
  <verify>
    pytest tests/api/ -v --tb=short
    python -c "from src.api.routes.preview import router; print('OK')"
  </verify>
  <done>
    Preview endpoint returns batch preview data; confirm endpoint triggers execution
  </done>
</task>

<task type="auto">
  <name>Task 2: Create command input and history components</name>
  <files>
    frontend/src/components/CommandInput.tsx
    frontend/src/components/CommandHistory.tsx
    frontend/src/lib/api.ts
  </files>
  <action>
    1. Create CommandInput.tsx:
       - Text input with placeholder: "Ship all California orders using UPS Ground..."
       - Submit on Enter key or button click
       - Loading state while submitting
       - Props: onSubmit(command: string) => Promise<void>
       - Use shadcn/ui Input and Button components
       - Example commands shown below input as clickable chips

    2. Create CommandHistory.tsx:
       - Displays recent commands as clickable list items
       - Props: commands: CommandHistoryItem[], onSelect(command: string) => void
       - Shows command text, status badge, timestamp
       - Use shadcn/ui Card for each item
       - Limit display to 5 most recent

    3. Update src/lib/api.ts:
       - Add getPreview(jobId: string): Promise<BatchPreview>
       - Add confirmBatch(jobId: string): Promise<ConfirmResponse>
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
  </verify>
  <done>
    CommandInput accepts and submits NL commands; CommandHistory shows reusable commands
  </done>
</task>

<task type="auto">
  <name>Task 3: Create preview grid, confirmation footer, and dashboard</name>
  <files>
    frontend/src/components/PreviewGrid.tsx
    frontend/src/components/ConfirmationFooter.tsx
    frontend/src/pages/Dashboard.tsx
    frontend/src/App.tsx
  </files>
  <action>
    1. Create PreviewGrid.tsx:
       - Displays shipment preview as card grid
       - Props: preview: BatchPreview, isLoading: boolean
       - Each PreviewRow renders as Card with:
         - Row number
         - Recipient name and city/state
         - Service type
         - Cost formatted as currency (cents to dollars)
         - Warning badges if warnings present
       - Summary at bottom: "Showing X of Y shipments" if additional_rows > 0
       - Total cost prominently displayed

    2. Create ConfirmationFooter.tsx:
       - Sticky footer bar at bottom of viewport
       - Props: totalCost: number, rowCount: number, onConfirm(), onCancel(), isLoading
       - Confirm button: "Confirm X Shipments ($Y.YY)"
       - Cancel button: "Cancel"
       - Disabled state during confirmation

    3. Create Dashboard.tsx (main page):
       - State management for workflow:
         - currentJobId: string | null
         - phase: 'input' | 'preview' | 'executing' | 'complete'
       - Renders CommandInput when phase='input'
       - Fetches preview when job created, shows PreviewGrid
       - Shows ConfirmationFooter when in preview phase
       - Handles confirmation flow

    4. Update App.tsx:
       - Import and render Dashboard as main component
       - Add minimal layout wrapper with header
  </action>
  <verify>
    cd /Users/matthewhans/Desktop/Programming/ShipAgent/frontend && npm run build
  </verify>
  <done>
    Dashboard orchestrates command -> preview -> confirm flow with all components integrated
  </done>
</task>

</tasks>

<verification>
1. Run: cd frontend && npm run build (builds without errors)
2. Run: pytest tests/api/ -v (API tests pass)
3. Manual: Start both servers, submit command, see preview cards, click confirm
4. Visual: Preview grid shows shipment cards with costs and warnings
5. Visual: Footer stays visible while scrolling through many shipments
</verification>

<success_criteria>
- [ ] CommandInput accepts text and calls onSubmit on Enter
- [ ] CommandHistory displays recent commands with click-to-reuse
- [ ] PreviewGrid renders shipment cards from BatchPreview data
- [ ] ConfirmationFooter shows sticky bar with confirm/cancel buttons
- [ ] Dashboard manages workflow state (input -> preview -> confirm)
- [ ] GET /api/v1/jobs/{id}/preview returns preview data
- [ ] POST /api/v1/jobs/{id}/confirm updates job status
- [ ] Costs display correctly formatted as currency
</success_criteria>

<output>
After completion, create `.planning/phases/07-web-interface/07-03-SUMMARY.md`
</output>
