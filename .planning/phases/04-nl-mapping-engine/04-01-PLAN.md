---
phase: 04-nl-mapping-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/orchestrator/__init__.py
  - src/orchestrator/nl_engine/__init__.py
  - src/orchestrator/models/__init__.py
  - src/orchestrator/models/intent.py
  - src/orchestrator/nl_engine/intent_parser.py
  - tests/orchestrator/test_intent_parser.py
autonomous: true

must_haves:
  truths:
    - "Natural language command 'Ship California orders via Ground' produces structured ShippingIntent"
    - "Service aliases (ground, overnight, 2-day) resolve to correct UPS codes (03, 01, 02)"
    - "Parser extracts data_source, filter_criteria, service_code from commands"
  artifacts:
    - path: "src/orchestrator/models/intent.py"
      provides: "ShippingIntent, FilterCriteria, RowQualifier Pydantic models"
      exports: ["ShippingIntent", "FilterCriteria", "RowQualifier", "ServiceCode"]
    - path: "src/orchestrator/nl_engine/intent_parser.py"
      provides: "parse_intent function using Claude structured outputs"
      exports: ["parse_intent", "SERVICE_ALIASES"]
  key_links:
    - from: "intent_parser.py"
      to: "anthropic.beta.messages.parse"
      via: "structured output with Pydantic model"
      pattern: "client\\.beta\\.messages\\.parse.*output_format"
---

<objective>
Create the intent parsing foundation for natural language shipping commands.

Purpose: Enable users to issue natural language commands like "Ship California orders via Ground" and have them parsed into structured intents that downstream components can process deterministically.

Output: Pydantic models for ShippingIntent/FilterCriteria and an intent parser using Claude structured outputs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-nl-mapping-engine/04-CONTEXT.md
@.planning/phases/04-nl-mapping-engine/04-RESEARCH.md
@src/mcp/data_source/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create orchestrator package and intent models</name>
  <files>
    - src/orchestrator/__init__.py
    - src/orchestrator/nl_engine/__init__.py
    - src/orchestrator/models/__init__.py
    - src/orchestrator/models/intent.py
  </files>
  <action>
Create the orchestrator package structure with intent models.

**Package structure:**
```
src/orchestrator/
  __init__.py           # Package marker
  nl_engine/
    __init__.py         # nl_engine exports
  models/
    __init__.py         # models exports
    intent.py           # Intent models
```

**In intent.py, create:**

1. `ServiceCode` - Enum for UPS service codes:
   - GROUND = "03"
   - NEXT_DAY_AIR = "01"
   - SECOND_DAY_AIR = "02"
   - THREE_DAY_SELECT = "12"
   - NEXT_DAY_AIR_SAVER = "13"

2. `SERVICE_ALIASES` - Dict mapping user terms to ServiceCode:
   - "ground" -> ServiceCode.GROUND
   - "overnight" / "next day" / "next day air" -> ServiceCode.NEXT_DAY_AIR
   - "2-day" / "two day" / "2nd day air" -> ServiceCode.SECOND_DAY_AIR
   - "3-day" / "three day" / "3 day select" -> ServiceCode.THREE_DAY_SELECT
   - "saver" / "next day air saver" -> ServiceCode.NEXT_DAY_AIR_SAVER

3. `RowQualifier` - Pydantic model for batch qualifiers:
   - qualifier_type: Literal["first", "last", "random", "every_nth", "all"]
   - count: Optional[int] = None  # For "first 10", "random sample of 5"
   - nth: Optional[int] = None    # For "every other row" (nth=2)

4. `FilterCriteria` - Pydantic model for filter expressions:
   - raw_expression: str  # Original NL filter text
   - filter_type: Literal["state", "date", "numeric", "compound", "none"]
   - needs_clarification: bool = False
   - clarification_reason: Optional[str] = None

5. `ShippingIntent` - Main Pydantic model:
   - action: Literal["ship", "rate", "validate_address"]
   - data_source: Optional[str] = None  # File path or table reference
   - service_code: Optional[ServiceCode] = None
   - filter_criteria: Optional[FilterCriteria] = None
   - row_qualifier: Optional[RowQualifier] = None
   - package_defaults: Optional[dict] = None  # Default dimensions/weight

Use Pydantic v2 patterns with Field descriptions. All models inherit from BaseModel with model_config = ConfigDict(from_attributes=True).
  </action>
  <verify>
```bash
python -c "from src.orchestrator.models.intent import ShippingIntent, ServiceCode, SERVICE_ALIASES; print(f'ServiceCode.GROUND={ServiceCode.GROUND.value}'); print(f'ground alias={SERVICE_ALIASES[\"ground\"]}')"
```
  </verify>
  <done>ShippingIntent model importable, ServiceCode enum has 5 service types, SERVICE_ALIASES maps all aliases from CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 2: Implement intent parser with Claude structured outputs</name>
  <files>
    - src/orchestrator/nl_engine/intent_parser.py
  </files>
  <action>
Create intent_parser.py that uses Claude structured outputs to parse NL commands.

**Dependencies:** Add `anthropic>=0.42.0` to pyproject.toml if not present.

**Implement:**

1. `resolve_service_code(user_input: str) -> ServiceCode`:
   - Normalize input (lowercase, strip)
   - Look up in SERVICE_ALIASES
   - If direct code provided ("03", "01"), return corresponding ServiceCode
   - Raise ValueError for unknown service

2. `parse_intent(user_command: str, available_sources: list[str] | None = None) -> ShippingIntent`:
   - Use anthropic.Anthropic() client
   - Call client.beta.messages.parse() with:
     - model: "claude-sonnet-4-5"
     - max_tokens: 1024
     - betas: ["structured-outputs-2025-11-13"]
     - output_format: ShippingIntent
   - System prompt should include:
     - Available data sources (if provided)
     - Service aliases reference
     - Current date for temporal context
     - Instructions to set needs_clarification=True for ambiguous filters
   - Post-process: If service_code is string alias, resolve via resolve_service_code()
   - Return parsed ShippingIntent

**Error handling:**
- Wrap API calls in try/except
- Raise IntentParseError (custom exception) on failures
- Include original command in error context

**Export from __init__.py:**
- parse_intent
- resolve_service_code
- IntentParseError
  </action>
  <verify>
```bash
python -c "
from src.orchestrator.nl_engine.intent_parser import parse_intent
# Dry run - will fail without API key but verifies imports
print('Intent parser imports successfully')
"
```
  </verify>
  <done>parse_intent function exists, uses Claude structured outputs with Pydantic model, resolves service aliases</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for intent parsing</name>
  <files>
    - tests/orchestrator/__init__.py
    - tests/orchestrator/test_intent_parser.py
  </files>
  <action>
Create comprehensive unit tests for intent parsing.

**Test file structure:**
```
tests/orchestrator/
  __init__.py
  test_intent_parser.py
```

**Test cases in test_intent_parser.py:**

1. `TestServiceCodeResolution`:
   - test_ground_alias -> ServiceCode.GROUND
   - test_overnight_alias -> ServiceCode.NEXT_DAY_AIR
   - test_next_day_alias -> ServiceCode.NEXT_DAY_AIR
   - test_two_day_alias -> ServiceCode.SECOND_DAY_AIR
   - test_three_day_alias -> ServiceCode.THREE_DAY_SELECT
   - test_saver_alias -> ServiceCode.NEXT_DAY_AIR_SAVER
   - test_direct_code_03 -> ServiceCode.GROUND
   - test_unknown_service_raises -> ValueError
   - test_case_insensitive -> "GROUND" works

2. `TestShippingIntentModel`:
   - test_minimal_intent -> action only
   - test_full_intent -> all fields populated
   - test_row_qualifier_first_10 -> RowQualifier(type="first", count=10)
   - test_filter_criteria_state -> FilterCriteria(type="state", raw="California")

3. `TestIntentParserIntegration` (mark as integration, skip without API key):
   - test_parse_simple_command -> "Ship orders via Ground"
   - test_parse_with_filter -> "Ship California orders"
   - test_parse_with_qualifier -> "Ship first 10 orders"

Use pytest with fixtures. Mark integration tests with @pytest.mark.integration and skipif ANTHROPIC_API_KEY not set.
  </action>
  <verify>
```bash
cd /Users/matthewhans/Desktop/Programming/ShipAgent && python -m pytest tests/orchestrator/test_intent_parser.py -v --ignore-glob="*integration*" -k "not Integration"
```
  </verify>
  <done>Unit tests pass for service code resolution and model validation; integration tests skip gracefully without API key</done>
</task>

</tasks>

<verification>
1. `python -c "from src.orchestrator.models.intent import ShippingIntent, ServiceCode"` succeeds
2. `python -c "from src.orchestrator.nl_engine.intent_parser import parse_intent"` succeeds
3. `pytest tests/orchestrator/test_intent_parser.py -v -k "not Integration"` passes
4. SERVICE_ALIASES contains all aliases from CONTEXT.md (ground, overnight, 2-day, 3-day, saver, etc.)
</verification>

<success_criteria>
1. ShippingIntent Pydantic model validates NL command structure
2. ServiceCode enum covers all 5 UPS service types used in MVP
3. SERVICE_ALIASES maps all aliases specified in CONTEXT.md
4. parse_intent function signature matches research pattern
5. Unit tests pass (8+ tests covering resolution and models)
</success_criteria>

<output>
After completion, create `.planning/phases/04-nl-mapping-engine/04-01-SUMMARY.md`
</output>
