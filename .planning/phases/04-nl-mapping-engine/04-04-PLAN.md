---
phase: 04-nl-mapping-engine
plan: 04
type: execute
wave: 2
depends_on: ["04-03"]
files_modified:
  - src/orchestrator/nl_engine/template_validator.py
  - src/orchestrator/nl_engine/ups_schema.py
  - tests/orchestrator/test_template_validator.py
autonomous: true

must_haves:
  truths:
    - "Generated Jinja2 template output validates against UPS ShipTo schema"
    - "Validation errors identify specific field paths that failed (e.g., 'ShipTo.Phone.Number')"
    - "Missing required fields are detected before execution"
  artifacts:
    - path: "src/orchestrator/nl_engine/template_validator.py"
      provides: "validate_template_output, TemplateValidationError"
      exports: ["validate_template_output", "TemplateValidationError", "ValidationResult"]
    - path: "src/orchestrator/nl_engine/ups_schema.py"
      provides: "UPS JSON Schema definitions for validation"
      exports: ["UPS_SHIPTO_SCHEMA", "UPS_PACKAGE_SCHEMA", "UPS_SHIPMENT_SCHEMA"]
  key_links:
    - from: "template_validator.py"
      to: "jsonschema.validate"
      via: "JSON Schema validation"
      pattern: "jsonschema\\.(validate|Draft[0-9]+Validator)"
---

<objective>
Create template validation against UPS schema to catch errors before execution.

Purpose: Ensure Jinja2 mapping templates produce outputs that conform to UPS API requirements, catching issues like missing required fields, incorrect types, or values exceeding length limits before attempting API calls.

Output: JSON Schema representations of UPS payload requirements and a validator that reports specific field-level errors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-nl-mapping-engine/04-CONTEXT.md
@.planning/phases/04-nl-mapping-engine/04-RESEARCH.md
@.planning/phases/04-nl-mapping-engine/04-03-SUMMARY.md
@packages/ups-mcp/src/generated/shipping.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UPS JSON Schema definitions</name>
  <files>
    - src/orchestrator/nl_engine/ups_schema.py
  </files>
  <action>
Create Python JSON Schema definitions matching UPS Zod schemas from Phase 3.

**Add to pyproject.toml dependencies:**
- jsonschema>=4.0.0

**In ups_schema.py, define JSON Schemas:**

Reference the Zod schemas in packages/ups-mcp/src/generated/shipping.ts and translate to JSON Schema format.

1. `UPS_PHONE_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "Number": {"type": "string", "minLength": 1, "maxLength": 15},
        "Extension": {"type": "string", "maxLength": 4}
    },
    "required": ["Number"]
}
```

2. `UPS_ADDRESS_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "AddressLine": {
            "type": "array",
            "items": {"type": "string", "maxLength": 35},
            "minItems": 1,
            "maxItems": 3
        },
        "City": {"type": "string", "minLength": 1, "maxLength": 30},
        "StateProvinceCode": {"type": "string", "maxLength": 5},
        "PostalCode": {"type": "string", "maxLength": 9},
        "CountryCode": {"type": "string", "minLength": 2, "maxLength": 2},
        "ResidentialAddressIndicator": {"type": "string"}
    },
    "required": ["AddressLine", "City", "CountryCode"]
}
```

3. `UPS_SHIPTO_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "Name": {"type": "string", "minLength": 1, "maxLength": 35},
        "AttentionName": {"type": "string", "maxLength": 35},
        "Phone": UPS_PHONE_SCHEMA,
        "Address": UPS_ADDRESS_SCHEMA
    },
    "required": ["Name", "Address"]
}
```

4. `UPS_PACKAGE_WEIGHT_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "UnitOfMeasurement": {
            "type": "object",
            "properties": {
                "Code": {"type": "string", "enum": ["LBS", "KGS"]},
                "Description": {"type": "string"}
            },
            "required": ["Code"]
        },
        "Weight": {"type": "string", "pattern": "^[0-9]+(\\.[0-9]+)?$"}
    },
    "required": ["UnitOfMeasurement", "Weight"]
}
```

5. `UPS_PACKAGE_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "Packaging": {
            "type": "object",
            "properties": {
                "Code": {"type": "string"},
                "Description": {"type": "string"}
            },
            "required": ["Code"]
        },
        "PackageWeight": UPS_PACKAGE_WEIGHT_SCHEMA
    },
    "required": ["Packaging", "PackageWeight"]
}
```

6. `UPS_SERVICE_SCHEMA`:
```python
{
    "type": "object",
    "properties": {
        "Code": {"type": "string", "enum": ["01", "02", "03", "12", "13", "14"]},
        "Description": {"type": "string"}
    },
    "required": ["Code"]
}
```

7. `UPS_SHIPMENT_SCHEMA` - Combines all above for full validation.

**Helper function:**
- `get_schema_for_path(path: str) -> dict`: Return appropriate schema for a target path (e.g., "ShipTo" -> UPS_SHIPTO_SCHEMA)
  </action>
  <verify>
```bash
python -c "
from src.orchestrator.nl_engine.ups_schema import UPS_SHIPTO_SCHEMA, UPS_PACKAGE_SCHEMA, get_schema_for_path
import json
print('ShipTo schema has', len(UPS_SHIPTO_SCHEMA['properties']), 'properties')
print('get_schema_for_path works:', 'Address' in get_schema_for_path('ShipTo')['properties'])
"
```
  </verify>
  <done>UPS JSON Schemas defined matching Zod schemas; get_schema_for_path returns correct schema for any target path</done>
</task>

<task type="auto">
  <name>Task 2: Implement template output validator</name>
  <files>
    - src/orchestrator/nl_engine/template_validator.py
    - src/orchestrator/nl_engine/__init__.py
  </files>
  <action>
Create template_validator.py that validates rendered template output against UPS schemas.

**Implement:**

1. `ValidationError` - Pydantic model for single validation error:
   - path: str  # JSONPath to failing field (e.g., "ShipTo.Phone.Number")
   - message: str  # Human-readable error description
   - expected: str  # What was expected (type, format, etc.)
   - actual: Any  # What was received
   - schema_rule: str  # Which schema rule was violated

2. `ValidationResult` - Pydantic model for validation outcome:
   - valid: bool
   - errors: list[ValidationError] = []
   - warnings: list[str] = []  # Non-blocking issues

3. `TemplateValidationError` - Exception:
   - result: ValidationResult
   - template_name: str

4. `validate_template_output(rendered_output: dict, target_schema: dict | None = None) -> ValidationResult`:
   - If no target_schema provided, use UPS_SHIPMENT_SCHEMA
   - Use jsonschema.Draft7Validator for validation
   - Collect ALL errors (not just first) using validator.iter_errors()
   - Convert jsonschema errors to ValidationError objects:
     - Extract path from error.absolute_path
     - Format message from error.message
     - Include expected type from error.schema
     - Include actual value from error.instance
   - Return ValidationResult with all errors

5. `validate_field_value(value: Any, target_path: str) -> ValidationResult`:
   - Get schema for path using get_schema_for_path()
   - Validate just that field
   - Useful for incremental validation during template building

6. `format_validation_errors(result: ValidationResult) -> str`:
   - Format errors for display to user or LLM:
     ```
     Validation failed with 2 errors:

     Error 1: ShipTo.Phone.Number
       Expected: string with 10-15 characters
       Got: "555-1234"
       Rule: maxLength

     Error 2: ShipTo.Address.PostalCode
       Expected: string matching ZIP format
       Got: None
       Rule: required
     ```
   - Per CONTEXT.md Decision 4: Include specific field, expected format, actual value

**Export from nl_engine/__init__.py:**
- validate_template_output
- validate_field_value
- format_validation_errors
- ValidationResult
- TemplateValidationError
  </action>
  <verify>
```bash
python -c "
from src.orchestrator.nl_engine.template_validator import validate_template_output, format_validation_errors

# Test with valid ShipTo data
valid_shipto = {
    'ShipTo': {
        'Name': 'John Smith',
        'Address': {
            'AddressLine': ['123 Main St'],
            'City': 'Los Angeles',
            'StateProvinceCode': 'CA',
            'PostalCode': '90001',
            'CountryCode': 'US'
        }
    }
}
from src.orchestrator.nl_engine.ups_schema import UPS_SHIPTO_SCHEMA
result = validate_template_output(valid_shipto['ShipTo'], UPS_SHIPTO_SCHEMA)
print(f'Valid data result: valid={result.valid}, errors={len(result.errors)}')

# Test with invalid data (missing City)
invalid_shipto = {
    'Name': 'John Smith',
    'Address': {
        'AddressLine': ['123 Main St'],
        'CountryCode': 'US'
    }
}
result2 = validate_template_output(invalid_shipto, UPS_SHIPTO_SCHEMA)
print(f'Invalid data result: valid={result2.valid}, errors={len(result2.errors)}')
print(format_validation_errors(result2))
"
```
  </verify>
  <done>validate_template_output catches all schema violations; format_validation_errors produces clear error messages per CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 3: Add tests for template validation</name>
  <files>
    - tests/orchestrator/test_template_validator.py
  </files>
  <action>
Create comprehensive tests for template validation.

**Test cases:**

1. `TestUPSSchemas`:
   - test_phone_schema_valid
   - test_phone_schema_missing_number
   - test_address_schema_valid
   - test_address_schema_missing_city
   - test_address_line_too_long -> maxLength 35
   - test_shipto_schema_valid
   - test_shipto_schema_missing_address
   - test_package_weight_valid
   - test_package_weight_invalid_format

2. `TestValidateTemplateOutput`:
   - test_valid_shipment_passes
   - test_missing_required_field_fails
   - test_type_mismatch_fails
   - test_string_too_long_fails
   - test_collects_all_errors -> Multiple errors in one validation
   - test_nested_field_path_correct -> "ShipTo.Address.City" not just "City"

3. `TestValidateFieldValue`:
   - test_valid_phone_number
   - test_invalid_phone_number
   - test_valid_address
   - test_invalid_address

4. `TestFormatValidationErrors`:
   - test_single_error_format
   - test_multiple_errors_format
   - test_includes_expected_and_actual
   - test_includes_schema_rule

5. `TestValidationResult`:
   - test_valid_result_no_errors
   - test_invalid_result_has_errors
   - test_warnings_separate_from_errors

**Fixtures:**
- valid_shipto_data
- valid_package_data
- valid_shipment_data
- invalid_shipto_missing_name
- invalid_address_line_too_long
  </action>
  <verify>
```bash
cd /Users/matthewhans/Desktop/Programming/ShipAgent && python -m pytest tests/orchestrator/test_template_validator.py -v
```
  </verify>
  <done>All validation tests pass; schema coverage includes all major UPS payload components</done>
</task>

</tasks>

<verification>
1. `python -c "from src.orchestrator.nl_engine.ups_schema import UPS_SHIPTO_SCHEMA"` succeeds
2. `python -c "from src.orchestrator.nl_engine.template_validator import validate_template_output"` succeeds
3. `pytest tests/orchestrator/test_template_validator.py -v` passes
4. Validation errors include full JSONPath to failing field
5. format_validation_errors produces output matching CONTEXT.md Decision 4 format
</verification>

<success_criteria>
1. JSON Schemas match UPS Zod schemas from Phase 3 (Phone, Address, ShipTo, Package, Service)
2. validate_template_output collects ALL errors, not just first
3. ValidationError includes path, message, expected, actual, and schema_rule
4. format_validation_errors produces user-friendly error output
5. Unit tests pass (20+ tests covering all schema types)
</success_criteria>

<output>
After completion, create `.planning/phases/04-nl-mapping-engine/04-04-SUMMARY.md`
</output>
