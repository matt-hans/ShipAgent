---
phase: 01-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/errors/__init__.py
  - src/errors/registry.py
  - src/errors/ups_translation.py
  - src/errors/formatter.py
autonomous: true

must_haves:
  truths:
    - "Error messages include specific failure reason and suggested remediation"
    - "Errors have unique codes in E-XXXX format"
    - "UPS API errors are translated to friendly messages"
    - "Same errors across multiple rows are grouped together"
  artifacts:
    - path: "src/errors/registry.py"
      provides: "Error code registry with E-XXXX codes"
      exports: ["ErrorCode", "ERROR_REGISTRY", "get_error"]
    - path: "src/errors/ups_translation.py"
      provides: "UPS error code to friendly message translation"
      exports: ["translate_ups_error", "UPS_ERROR_MAP"]
    - path: "src/errors/formatter.py"
      provides: "Error formatting and grouping utilities"
      exports: ["format_error", "group_errors", "ShipAgentError"]
  key_links:
    - from: "src/errors/formatter.py"
      to: "src/errors/registry.py"
      via: "imports error codes for formatting"
      pattern: "from.*registry.*import"
    - from: "src/errors/formatter.py"
      to: "src/errors/ups_translation.py"
      via: "uses UPS translation for API errors"
      pattern: "from.*ups_translation.*import"
---

<objective>
Create the error handling framework with error code registry, UPS error translation, and error formatting utilities.

Purpose: Provide consistent, user-friendly error messages with actionable remediation steps, enabling users to fix issues without developer support.

Output: Error framework with E-XXXX codes, UPS translation map, and grouping/formatting utilities.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error code registry</name>
  <files>
    - src/errors/__init__.py
    - src/errors/registry.py
  </files>
  <action>
Create the error code registry with E-XXXX format codes.

**src/errors/registry.py**:

1. **ErrorCode dataclass**:
   ```python
   from dataclasses import dataclass
   from enum import Enum

   class ErrorCategory(Enum):
       DATA = "data"  # E-1xxx: User data errors
       VALIDATION = "validation"  # E-2xxx: Validation errors
       UPS_API = "ups_api"  # E-3xxx: UPS API errors
       SYSTEM = "system"  # E-4xxx: System/internal errors
       AUTH = "auth"  # E-5xxx: Authentication errors

   @dataclass
   class ErrorCode:
       code: str  # E-XXXX format
       category: ErrorCategory
       title: str  # Short title for display
       message_template: str  # Message with {placeholders}
       remediation: str  # Action user should take
       is_retryable: bool = False  # Can be retried without user action
   ```

2. **Error registry** (initial set of common errors):
   ```python
   ERROR_REGISTRY: dict[str, ErrorCode] = {
       # Data errors (E-1xxx)
       "E-1001": ErrorCode(
           code="E-1001",
           category=ErrorCategory.DATA,
           title="Missing Required Field",
           message_template="Required field '{field}' is missing in row {row}.",
           remediation="Add the missing field to your data source and retry.",
       ),
       "E-1002": ErrorCode(
           code="E-1002",
           category=ErrorCategory.DATA,
           title="Empty Data Source",
           message_template="No rows found in data source after applying filters.",
           remediation="Check your filter criteria or verify the data source contains data.",
       ),
       "E-1003": ErrorCode(
           code="E-1003",
           category=ErrorCategory.DATA,
           title="Invalid Data Type",
           message_template="Field '{field}' in row {row} has invalid type. Expected {expected}, got {actual}.",
           remediation="Correct the data type in your source and retry.",
       ),

       # Validation errors (E-2xxx)
       "E-2001": ErrorCode(
           code="E-2001",
           category=ErrorCategory.VALIDATION,
           title="Invalid ZIP Code",
           message_template="Invalid ZIP code format in row {row}, column '{column}'. Value: '{value}'.",
           remediation="US ZIP codes should be 5 digits (12345) or 9 digits (12345-6789). Correct and retry.",
       ),
       "E-2002": ErrorCode(
           code="E-2002",
           category=ErrorCategory.VALIDATION,
           title="Invalid State Code",
           message_template="Invalid state code '{value}' in row {row}. Must be 2-letter US state code.",
           remediation="Use standard 2-letter state codes (CA, NY, TX, etc.). Correct and retry.",
       ),
       "E-2003": ErrorCode(
           code="E-2003",
           category=ErrorCategory.VALIDATION,
           title="Invalid Phone Number",
           message_template="Invalid phone number format in row {row}. Value: '{value}'.",
           remediation="Phone numbers should be 10 digits. Remove special characters and retry.",
       ),
       "E-2004": ErrorCode(
           code="E-2004",
           category=ErrorCategory.VALIDATION,
           title="Invalid Weight",
           message_template="Invalid weight '{value}' in row {row}. Weight must be positive number.",
           remediation="Correct the weight value and retry.",
       ),
       "E-2005": ErrorCode(
           code="E-2005",
           category=ErrorCategory.VALIDATION,
           title="Address Too Long",
           message_template="Address in row {row} exceeds maximum length ({max_length} characters).",
           remediation="Shorten the address field and retry. UPS limits address lines to 35 characters.",
       ),

       # UPS API errors (E-3xxx)
       "E-3001": ErrorCode(
           code="E-3001",
           category=ErrorCategory.UPS_API,
           title="UPS Service Unavailable",
           message_template="UPS {service} API is not responding.",
           remediation="Wait a few minutes and retry. Check UPS system status at ups.com if issue persists.",
           is_retryable=True,
       ),
       "E-3002": ErrorCode(
           code="E-3002",
           category=ErrorCategory.UPS_API,
           title="UPS Rate Limit Exceeded",
           message_template="Too many requests to UPS API. Rate limit exceeded.",
           remediation="Wait 60 seconds and retry. Consider reducing batch size.",
           is_retryable=True,
       ),
       "E-3003": ErrorCode(
           code="E-3003",
           category=ErrorCategory.UPS_API,
           title="UPS Address Validation Failed",
           message_template="UPS could not validate address in row {row}.",
           remediation="Verify the address is complete and correct. Check for typos.",
       ),
       "E-3004": ErrorCode(
           code="E-3004",
           category=ErrorCategory.UPS_API,
           title="UPS Service Not Available",
           message_template="UPS {service} is not available for this shipment.",
           remediation="Try a different service level or verify delivery address is serviceable.",
       ),
       "E-3005": ErrorCode(
           code="E-3005",
           category=ErrorCategory.UPS_API,
           title="UPS Unknown Error",
           message_template="UPS returned an unexpected error: {ups_message}",
           remediation="Contact support with error code E-3005 and the UPS message for assistance.",
       ),

       # System errors (E-4xxx)
       "E-4001": ErrorCode(
           code="E-4001",
           category=ErrorCategory.SYSTEM,
           title="Database Error",
           message_template="Database operation failed: {details}",
           remediation="This is a system error. Retry the operation. Contact support if issue persists.",
           is_retryable=True,
       ),
       "E-4002": ErrorCode(
           code="E-4002",
           category=ErrorCategory.SYSTEM,
           title="File System Error",
           message_template="Could not {operation} file: {path}",
           remediation="Check disk space and permissions. Retry the operation.",
           is_retryable=True,
       ),
       "E-4003": ErrorCode(
           code="E-4003",
           category=ErrorCategory.SYSTEM,
           title="Template Error",
           message_template="Error processing mapping template: {details}",
           remediation="This indicates a problem with the generated mapping. Contact support.",
       ),

       # Auth errors (E-5xxx)
       "E-5001": ErrorCode(
           code="E-5001",
           category=ErrorCategory.AUTH,
           title="UPS Authentication Failed",
           message_template="Failed to authenticate with UPS API.",
           remediation="Check your UPS credentials in settings. Verify client ID and secret are correct.",
       ),
       "E-5002": ErrorCode(
           code="E-5002",
           category=ErrorCategory.AUTH,
           title="UPS Token Expired",
           message_template="UPS access token has expired and could not be refreshed.",
           remediation="Re-authenticate with UPS in settings.",
           is_retryable=True,
       ),
   }
   ```

3. **Lookup function**:
   ```python
   def get_error(code: str) -> ErrorCode | None:
       """Get error definition by code."""
       return ERROR_REGISTRY.get(code)

   def get_errors_by_category(category: ErrorCategory) -> list[ErrorCode]:
       """Get all errors in a category."""
       return [e for e in ERROR_REGISTRY.values() if e.category == category]
   ```

**src/errors/__init__.py**:
```python
from src.errors.registry import (
    ErrorCode,
    ErrorCategory,
    ERROR_REGISTRY,
    get_error,
    get_errors_by_category,
)

__all__ = [
    "ErrorCode",
    "ErrorCategory",
    "ERROR_REGISTRY",
    "get_error",
    "get_errors_by_category",
]
```
  </action>
  <verify>
    - `python -c "from src.errors import get_error; e = get_error('E-2001'); print(f'{e.code}: {e.title}')"` works
    - `python -c "from src.errors import ERROR_REGISTRY; print(f'{len(ERROR_REGISTRY)} errors defined')"` shows count
  </verify>
  <done>
    - ErrorCode dataclass defined with all required fields
    - ERROR_REGISTRY contains initial error codes
    - Errors organized by category (E-1xxx through E-5xxx)
    - get_error() lookup function works
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UPS error translation map</name>
  <files>
    - src/errors/ups_translation.py
  </files>
  <action>
Create UPS error code translation to friendly messages.

**src/errors/ups_translation.py**:

1. **UPS error code to ShipAgent error mapping**:
   ```python
   from src.errors.registry import get_error, ErrorCode

   # Map of UPS error codes to ShipAgent error codes
   # Source: UPS API error documentation
   UPS_ERROR_MAP: dict[str, str] = {
       # Address validation errors
       "120100": "E-3003",  # Address validation failed
       "120101": "E-3003",  # Invalid postal code
       "120102": "E-3003",  # Invalid city/state combination
       "120104": "E-3003",  # Invalid address

       # Service availability errors
       "111030": "E-3004",  # Service not available
       "111050": "E-3004",  # Delivery not available to postal code
       "111057": "E-3004",  # Service not available for package type

       # Weight/dimension errors
       "120500": "E-2004",  # Invalid weight
       "120501": "E-2004",  # Weight exceeds limit
       "120502": "E-2004",  # Invalid dimensions

       # Rate errors
       "111210": "E-3004",  # Rate not available

       # Authentication errors
       "250001": "E-5001",  # Invalid credentials
       "250002": "E-5001",  # Authentication failed
       "250003": "E-5002",  # Token expired

       # System/availability errors
       "190001": "E-3001",  # System unavailable
       "190002": "E-3001",  # Service temporarily unavailable
       "190100": "E-3002",  # Rate limit exceeded
   }

   # Additional UPS error messages that require pattern matching
   UPS_MESSAGE_PATTERNS: dict[str, str] = {
       "invalid zip": "E-2001",
       "invalid postal": "E-2001",
       "address not found": "E-3003",
       "service unavailable": "E-3001",
       "rate limit": "E-3002",
       "unauthorized": "E-5001",
       "token expired": "E-5002",
   }
   ```

2. **Translation function**:
   ```python
   def translate_ups_error(
       ups_code: str | None,
       ups_message: str | None,
       context: dict | None = None
   ) -> tuple[str, str, str]:
       """
       Translate UPS error to ShipAgent error.

       Args:
           ups_code: UPS error code (e.g., "120100")
           ups_message: UPS error message text
           context: Additional context (row number, field name, etc.)

       Returns:
           Tuple of (error_code, formatted_message, remediation)
       """
       context = context or {}

       # Try direct code lookup first
       if ups_code and ups_code in UPS_ERROR_MAP:
           sa_code = UPS_ERROR_MAP[ups_code]
           error = get_error(sa_code)
           if error:
               message = error.message_template.format(
                   ups_message=ups_message or "Unknown error",
                   **context
               )
               return (error.code, message, error.remediation)

       # Try message pattern matching
       if ups_message:
           ups_message_lower = ups_message.lower()
           for pattern, sa_code in UPS_MESSAGE_PATTERNS.items():
               if pattern in ups_message_lower:
                   error = get_error(sa_code)
                   if error:
                       message = error.message_template.format(
                           ups_message=ups_message,
                           **context
                       )
                       return (error.code, message, error.remediation)

       # Fallback to generic UPS error
       error = get_error("E-3005")  # UPS Unknown Error
       if error:
           message = error.message_template.format(
               ups_message=ups_message or f"Code: {ups_code}",
               **context
           )
           return (error.code, message, error.remediation)

       # Ultimate fallback
       return (
           "E-3005",
           f"UPS error: {ups_message or ups_code or 'Unknown'}",
           "Contact support with this error message for assistance."
       )
   ```

3. **Utility to extract UPS error from API response**:
   ```python
   def extract_ups_error(response: dict) -> tuple[str | None, str | None]:
       """
       Extract error code and message from UPS API response.

       UPS responses vary in structure. This handles common formats.
       """
       # Format 1: response.errors[0].code/message
       if "errors" in response and response["errors"]:
           err = response["errors"][0]
           return (err.get("code"), err.get("message"))

       # Format 2: response.response.errors[0]
       if "response" in response:
           inner = response["response"]
           if "errors" in inner and inner["errors"]:
               err = inner["errors"][0]
               return (err.get("code"), err.get("message"))

       # Format 3: Fault format
       if "Fault" in response:
           fault = response["Fault"]
           if "detail" in fault:
               detail = fault["detail"]
               if "Errors" in detail:
                   err = detail["Errors"]
                   if isinstance(err, dict) and "ErrorDetail" in err:
                       ed = err["ErrorDetail"]
                       if isinstance(ed, list):
                           ed = ed[0]
                       return (
                           ed.get("PrimaryErrorCode", {}).get("Code"),
                           ed.get("PrimaryErrorCode", {}).get("Description")
                       )

       return (None, None)
   ```
  </action>
  <verify>
    - `python -c "from src.errors.ups_translation import translate_ups_error; print(translate_ups_error('120100', None))"` returns E-3003
    - `python -c "from src.errors.ups_translation import translate_ups_error; print(translate_ups_error(None, 'invalid zip code'))"` returns E-2001
  </verify>
  <done>
    - UPS_ERROR_MAP contains common UPS error codes
    - UPS_MESSAGE_PATTERNS handles message-based matching
    - translate_ups_error() returns friendly ShipAgent errors
    - extract_ups_error() parses various UPS response formats
  </done>
</task>

<task type="auto">
  <name>Task 3: Create error formatter and grouping utilities</name>
  <files>
    - src/errors/formatter.py
    - src/errors/__init__.py
  </files>
  <action>
Create error formatting and grouping utilities.

**src/errors/formatter.py**:

1. **ShipAgentError exception class**:
   ```python
   from dataclasses import dataclass, field
   from src.errors.registry import ErrorCode, get_error

   @dataclass
   class ShipAgentError(Exception):
       """Application error with code, message, and context."""
       code: str
       message: str
       remediation: str
       rows: list[int] = field(default_factory=list)  # Affected row numbers
       column: str | None = None  # Affected column name
       is_retryable: bool = False
       details: dict = field(default_factory=dict)  # Additional context

       def __str__(self) -> str:
           return f"{self.code}: {self.message}"

       @classmethod
       def from_code(cls, code: str, **kwargs) -> "ShipAgentError":
           """Create error from registry code with context substitution."""
           error_def = get_error(code)
           if not error_def:
               return cls(
                   code=code,
                   message=f"Unknown error: {code}",
                   remediation="Contact support.",
                   **kwargs
               )

           # Format message with provided context
           message = error_def.message_template
           try:
               message = message.format(**kwargs)
           except KeyError:
               # Keep template if some placeholders missing
               pass

           return cls(
               code=error_def.code,
               message=message,
               remediation=error_def.remediation,
               is_retryable=error_def.is_retryable,
               **{k: v for k, v in kwargs.items() if k in ['rows', 'column', 'details']}
           )
   ```

2. **Error formatting function**:
   ```python
   def format_error(error: ShipAgentError, include_remediation: bool = True) -> str:
       """
       Format error for display to user.

       Returns multi-line formatted string.
       """
       lines = [f"{error.code}: {error.message}"]

       # Add row/column context
       if error.rows:
           if len(error.rows) == 1:
               lines.append(f"  Location: Row {error.rows[0]}")
           else:
               rows_str = ", ".join(str(r) for r in error.rows[:10])
               if len(error.rows) > 10:
                   rows_str += f" (and {len(error.rows) - 10} more)"
               lines.append(f"  Affected rows: {rows_str}")

       if error.column:
           lines.append(f"  Column: {error.column}")

       # Add remediation
       if include_remediation:
           lines.append(f"  Action: {error.remediation}")

       return "\n".join(lines)
   ```

3. **Error grouping function**:
   ```python
   def group_errors(errors: list[ShipAgentError]) -> list[ShipAgentError]:
       """
       Group errors by code and message, combining row numbers.

       Example: 5 identical "Invalid ZIP" errors on rows 1,2,3,4,5
               -> 1 error with rows=[1,2,3,4,5]
       """
       groups: dict[str, ShipAgentError] = {}

       for error in errors:
           # Create a key from code and message (not rows)
           key = f"{error.code}|{error.message}|{error.column or ''}"

           if key in groups:
               # Add rows to existing group
               groups[key].rows.extend(error.rows)
           else:
               # Create new group
               groups[key] = ShipAgentError(
                   code=error.code,
                   message=error.message,
                   remediation=error.remediation,
                   rows=list(error.rows),  # Copy to avoid mutation
                   column=error.column,
                   is_retryable=error.is_retryable,
                   details=error.details.copy(),
               )

       # Sort rows within each group and return as list
       result = list(groups.values())
       for error in result:
           error.rows = sorted(set(error.rows))  # Dedupe and sort

       return result
   ```

4. **Format grouped errors for display**:
   ```python
   def format_error_summary(errors: list[ShipAgentError]) -> str:
       """
       Format a list of errors for display, grouping duplicates.

       Returns user-friendly summary suitable for UI display.
       """
       if not errors:
           return "No errors."

       grouped = group_errors(errors)

       if len(grouped) == 1:
           return format_error(grouped[0])

       lines = [f"{len(grouped)} error type(s) found:\n"]
       for i, error in enumerate(grouped, 1):
           lines.append(f"{i}. {format_error(error)}")
           lines.append("")  # Blank line between errors

       return "\n".join(lines)
   ```

**Update src/errors/__init__.py**:
```python
from src.errors.registry import (
    ErrorCode,
    ErrorCategory,
    ERROR_REGISTRY,
    get_error,
    get_errors_by_category,
)
from src.errors.ups_translation import (
    translate_ups_error,
    extract_ups_error,
    UPS_ERROR_MAP,
)
from src.errors.formatter import (
    ShipAgentError,
    format_error,
    group_errors,
    format_error_summary,
)

__all__ = [
    # Registry
    "ErrorCode",
    "ErrorCategory",
    "ERROR_REGISTRY",
    "get_error",
    "get_errors_by_category",
    # UPS translation
    "translate_ups_error",
    "extract_ups_error",
    "UPS_ERROR_MAP",
    # Formatter
    "ShipAgentError",
    "format_error",
    "group_errors",
    "format_error_summary",
]
```
  </action>
  <verify>
    - Run integration test (see verification section)
  </verify>
  <done>
    - ShipAgentError exception class works with registry
    - format_error() produces readable output
    - group_errors() combines duplicates
    - format_error_summary() handles multiple errors
    - All exports updated in __init__.py
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run this integration test:

```bash
python -c "
from src.errors import (
    get_error, ErrorCategory, ERROR_REGISTRY,
    translate_ups_error, extract_ups_error,
    ShipAgentError, format_error, group_errors, format_error_summary
)

# Test registry
print('1. Testing error registry:')
e = get_error('E-2001')
print(f'   {e.code}: {e.title}')
print(f'   Category: {e.category.value}')
print(f'   Total errors defined: {len(ERROR_REGISTRY)}')

# Test UPS translation
print('\\n2. Testing UPS error translation:')
code, msg, remedy = translate_ups_error('120100', 'Address validation failed', {'row': 5})
print(f'   UPS 120100 -> {code}')
print(f'   Message: {msg}')

code, msg, remedy = translate_ups_error(None, 'invalid zip code in request')
print(f'   Pattern match -> {code}')

# Test ShipAgentError creation
print('\\n3. Testing ShipAgentError:')
err = ShipAgentError.from_code('E-2001', row=5, column='zip_code', value='1234')
print(f'   Created: {err}')

# Test formatting
print('\\n4. Testing error formatting:')
err = ShipAgentError(
    code='E-2001',
    message='Invalid ZIP code in row 5',
    remediation='Use 5 or 9 digit ZIP.',
    rows=[5],
    column='zip_code'
)
print(format_error(err))

# Test grouping
print('\\n5. Testing error grouping:')
errors = [
    ShipAgentError(code='E-2001', message='Invalid ZIP', remediation='Fix ZIP', rows=[1]),
    ShipAgentError(code='E-2001', message='Invalid ZIP', remediation='Fix ZIP', rows=[3]),
    ShipAgentError(code='E-2001', message='Invalid ZIP', remediation='Fix ZIP', rows=[5]),
    ShipAgentError(code='E-2003', message='Invalid phone', remediation='Fix phone', rows=[2]),
]
grouped = group_errors(errors)
print(f'   {len(errors)} errors grouped into {len(grouped)} unique errors')
print(f'   ZIP error affects rows: {grouped[0].rows}')

# Test summary formatting
print('\\n6. Testing error summary:')
print(format_error_summary(errors))

# Test UPS response extraction
print('7. Testing UPS response extraction:')
response = {
    'errors': [{'code': '120100', 'message': 'Invalid postal code'}]
}
code, msg = extract_ups_error(response)
print(f'   Extracted: code={code}, message={msg}')

print('\\nAll tests passed!')
"
```
</verification>

<success_criteria>
1. Error codes follow E-XXXX format with logical categorization
2. Registry contains errors for data, validation, UPS, system, and auth categories
3. UPS error codes translate to friendly ShipAgent errors
4. Pattern matching catches UPS errors without known codes
5. ShipAgentError.from_code() creates errors from registry with context
6. Error grouping combines duplicate errors across rows
7. Formatted output is clear and actionable for end users
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
