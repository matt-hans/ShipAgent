---
phase: 02-data-source-mcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mcp/__init__.py
  - src/mcp/data_source/__init__.py
  - src/mcp/data_source/models.py
  - src/mcp/data_source/adapters/__init__.py
  - src/mcp/data_source/adapters/base.py
  - src/mcp/data_source/tools/__init__.py
  - src/mcp/data_source/server.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "FastMCP server initializes without errors"
    - "DuckDB connection is created in lifespan context"
    - "BaseSourceAdapter ABC defines import interface"
  artifacts:
    - path: "src/mcp/data_source/server.py"
      provides: "FastMCP server with DuckDB lifespan"
      exports: ["mcp"]
    - path: "src/mcp/data_source/models.py"
      provides: "Pydantic models for tool I/O"
      exports: ["SchemaColumn", "ImportResult", "RowData"]
    - path: "src/mcp/data_source/adapters/base.py"
      provides: "Abstract base class for source adapters"
      exports: ["BaseSourceAdapter"]
  key_links:
    - from: "src/mcp/data_source/server.py"
      to: "duckdb connection"
      via: "lifespan context manager"
      pattern: "yield.*db.*conn"
---

<objective>
Create the Data Source MCP foundation: package structure, Pydantic models, FastMCP server with DuckDB lifespan, and BaseSourceAdapter ABC.

Purpose: Establish the scaffolding that all subsequent plans build upon. Tools, adapters, and the server all depend on this foundation.

Output: Runnable (but empty) FastMCP server with DuckDB connection management ready for tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-source-mcp/02-CONTEXT.md
@.planning/phases/02-data-source-mcp/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Package Structure and Pydantic Models</name>
  <files>
    src/mcp/__init__.py
    src/mcp/data_source/__init__.py
    src/mcp/data_source/models.py
    src/mcp/data_source/adapters/__init__.py
    src/mcp/data_source/tools/__init__.py
    pyproject.toml
  </files>
  <action>
Create the MCP package structure per RESEARCH.md architecture.

1. Create directories: `src/mcp/`, `src/mcp/data_source/`, `src/mcp/data_source/adapters/`, `src/mcp/data_source/tools/`

2. Create `src/mcp/__init__.py` - empty init

3. Create `src/mcp/data_source/__init__.py` with exports for models and server

4. Create `src/mcp/data_source/models.py` with Pydantic models:
   - `SchemaColumn`: name (str), type (str), nullable (bool), warnings (list[str])
   - `ImportResult`: row_count (int), columns (list[SchemaColumn]), warnings (list[str]), source_type (str)
   - `RowData`: row_number (int), data (dict), checksum (str | None)
   - `QueryResult`: rows (list[RowData]), total_count (int)
   - `ChecksumResult`: row_number (int), checksum (str)
   - `DateWarning`: column (str), sample_value (str), us_interpretation (str), eu_interpretation (str)
   - `ValidationError`: row_number (int), column (str), message (str), value (Any)

5. Update `pyproject.toml` to add dependencies:
   - fastmcp<3
   - duckdb>=1.3.0
   - openpyxl>=3.1.0
   - python-dateutil>=2.9.0
  </action>
  <verify>
    - `python -c "from src.mcp.data_source.models import SchemaColumn, ImportResult, RowData"` succeeds
    - All directories exist with __init__.py files
    - Dependencies added to pyproject.toml
  </verify>
  <done>Package structure created. Pydantic models importable. Dependencies declared.</done>
</task>

<task type="auto">
  <name>Task 2: BaseSourceAdapter Abstract Class</name>
  <files>
    src/mcp/data_source/adapters/base.py
    src/mcp/data_source/adapters/__init__.py
  </files>
  <action>
Create the abstract base class for all data source adapters.

1. Create `src/mcp/data_source/adapters/base.py`:
   - Import ABC, abstractmethod from abc
   - Import duckdb.DuckDBPyConnection for type hints
   - Define `BaseSourceAdapter` ABC with:
     - `source_type: str` - abstract property ("csv", "excel", "database")
     - `import_data(conn: DuckDBPyConnection, **kwargs) -> ImportResult` - abstract method
     - `get_metadata(conn: DuckDBPyConnection) -> dict` - abstract method (returns source-specific info)
   - Add docstrings explaining each method's contract

2. Update `src/mcp/data_source/adapters/__init__.py`:
   - Export BaseSourceAdapter
  </action>
  <verify>
    - `python -c "from src.mcp.data_source.adapters.base import BaseSourceAdapter"` succeeds
    - `BaseSourceAdapter` cannot be instantiated directly (raises TypeError)
  </verify>
  <done>BaseSourceAdapter ABC defined with import_data and get_metadata contracts.</done>
</task>

<task type="auto">
  <name>Task 3: FastMCP Server with DuckDB Lifespan</name>
  <files>
    src/mcp/data_source/server.py
    src/mcp/data_source/utils.py
  </files>
  <action>
Create the FastMCP server skeleton with DuckDB connection management.

1. Create `src/mcp/data_source/utils.py` with helper functions:
   - `compute_row_checksum(row_data: dict) -> str`: SHA-256 via hashlib + JSON with sorted keys
   - `parse_date_with_warnings(value: str) -> dict`: Date parsing with US/EU ambiguity detection per RESEARCH.md

2. Create `src/mcp/data_source/server.py`:
   ```python
   from contextlib import asynccontextmanager
   from fastmcp import FastMCP
   import duckdb

   @asynccontextmanager
   async def lifespan(app):
       """Initialize DuckDB with database extensions."""
       conn = duckdb.connect(":memory:")
       # Install extensions for PostgreSQL/MySQL connectivity
       conn.execute("INSTALL postgres; INSTALL mysql;")
       conn.execute("LOAD postgres; LOAD mysql;")

       yield {
           "db": conn,
           "current_source": None,  # Track active source metadata
           "type_overrides": {},    # Per-column type overrides
       }

       conn.close()

   mcp = FastMCP("DataSource", lifespan=lifespan)

   if __name__ == "__main__":
       mcp.run(transport="stdio")
   ```

3. CRITICAL: Do NOT use print() anywhere - use ctx.info() for logging per RESEARCH.md pitfalls.
  </action>
  <verify>
    - `python -c "from src.mcp.data_source.server import mcp"` succeeds
    - `python -c "from src.mcp.data_source.utils import compute_row_checksum, parse_date_with_warnings"` succeeds
    - Checksum of `{"a": 1, "b": 2}` equals checksum of `{"b": 2, "a": 1}` (sorted keys)
  </verify>
  <done>FastMCP server created with DuckDB lifespan. Utils helpers ready. No tools yet - just infrastructure.</done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:

```bash
# Install new dependencies
cd /Users/matthewhans/Desktop/Programming/ShipAgent
source .venv/bin/activate
pip install 'fastmcp<3' 'duckdb>=1.3.0' 'openpyxl>=3.1.0' 'python-dateutil>=2.9.0'

# Verify imports
python -c "
from src.mcp.data_source.models import SchemaColumn, ImportResult, RowData, QueryResult, ChecksumResult
from src.mcp.data_source.adapters.base import BaseSourceAdapter
from src.mcp.data_source.server import mcp
from src.mcp.data_source.utils import compute_row_checksum, parse_date_with_warnings

# Test checksum determinism
assert compute_row_checksum({'a': 1, 'b': 2}) == compute_row_checksum({'b': 2, 'a': 1})

print('All imports successful, checksum deterministic')
"

# Verify BaseSourceAdapter is abstract
python -c "
from src.mcp.data_source.adapters.base import BaseSourceAdapter
try:
    BaseSourceAdapter()
    print('ERROR: Should not be instantiable')
    exit(1)
except TypeError:
    print('BaseSourceAdapter correctly abstract')
"
```
</verification>

<success_criteria>
1. Package structure exists: src/mcp/data_source/{models.py, server.py, utils.py, adapters/, tools/}
2. Pydantic models importable: SchemaColumn, ImportResult, RowData, QueryResult, ChecksumResult
3. BaseSourceAdapter ABC cannot be instantiated directly
4. FastMCP server imports without error
5. compute_row_checksum produces deterministic hashes (order-independent)
6. Dependencies added to pyproject.toml: fastmcp<3, duckdb>=1.3.0, openpyxl>=3.1.0, python-dateutil>=2.9.0
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-source-mcp/02-01-SUMMARY.md`
</output>
