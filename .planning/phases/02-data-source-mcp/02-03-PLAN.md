---
phase: 02-data-source-mcp
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/mcp/data_source/adapters/excel_adapter.py
  - src/mcp/data_source/tools/import_tools.py
  - src/mcp/data_source/server.py
autonomous: true

must_haves:
  truths:
    - "User can list available sheets in an Excel file"
    - "User can import a specific sheet from an Excel file"
    - "Schema discovery works for Excel sheets"
    - "Empty rows are silently skipped"
  artifacts:
    - path: "src/mcp/data_source/adapters/excel_adapter.py"
      provides: "Excel import via DuckDB + openpyxl sheet discovery"
      exports: ["ExcelAdapter"]
    - path: "src/mcp/data_source/tools/import_tools.py"
      provides: "MCP import_excel and list_sheets tools"
      exports: ["import_excel", "list_sheets"]
  key_links:
    - from: "src/mcp/data_source/tools/import_tools.py"
      to: "ExcelAdapter"
      via: "adapter instantiation"
      pattern: "ExcelAdapter\\("
    - from: "src/mcp/data_source/tools/import_tools.py"
      to: "openpyxl"
      via: "sheet discovery"
      pattern: "load_workbook"
---

<objective>
Implement Excel import capability with sheet selection and schema discovery.

Purpose: Satisfy DATA-02 requirement - users can import shipment data from Excel files (.xlsx) with sheet selection.

Output: Working import_excel and list_sheets MCP tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-source-mcp/02-CONTEXT.md
@.planning/phases/02-data-source-mcp/02-RESEARCH.md
@.planning/phases/02-data-source-mcp/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Excel Adapter Implementation</name>
  <files>
    src/mcp/data_source/adapters/excel_adapter.py
    src/mcp/data_source/adapters/__init__.py
  </files>
  <action>
Create the Excel adapter using DuckDB's read_xlsx and openpyxl for sheet discovery.

1. Create `src/mcp/data_source/adapters/excel_adapter.py`:
   ```python
   """Excel adapter for Data Source MCP."""

   from pathlib import Path
   from typing import Optional
   from duckdb import DuckDBPyConnection
   from openpyxl import load_workbook

   from .base import BaseSourceAdapter
   from ..models import ImportResult, SchemaColumn
   from ..utils import parse_date_with_warnings


   class ExcelAdapter(BaseSourceAdapter):
       """Adapter for importing Excel files via DuckDB."""

       @property
       def source_type(self) -> str:
           return "excel"

       def list_sheets(self, file_path: str) -> list[str]:
           """List all sheet names in an Excel file.

           Args:
               file_path: Path to Excel file

           Returns:
               List of sheet names
           """
           path = Path(file_path)
           if not path.exists():
               raise FileNotFoundError(f"Excel file not found: {file_path}")

           # Use openpyxl in read_only mode for efficiency
           wb = load_workbook(file_path, read_only=True, data_only=True)
           sheet_names = wb.sheetnames
           wb.close()

           return sheet_names

       def import_data(
           self,
           conn: DuckDBPyConnection,
           file_path: str,
           sheet: Optional[str] = None,
           header: bool = True,
       ) -> ImportResult:
           """Import Excel sheet into DuckDB.

           Args:
               conn: DuckDB connection
               file_path: Path to Excel file (.xlsx)
               sheet: Sheet name to import (default: first sheet)
               header: Whether first row is header (default: True)

           Returns:
               ImportResult with schema and row count
           """
           path = Path(file_path)
           if not path.exists():
               raise FileNotFoundError(f"Excel file not found: {file_path}")

           # Get sheet name if not provided
           if sheet is None:
               sheets = self.list_sheets(file_path)
               if not sheets:
                   raise ValueError("Excel file contains no sheets")
               sheet = sheets[0]

           # Install and load spatial extension for Excel support if needed
           try:
               conn.execute("INSTALL spatial;")
               conn.execute("LOAD spatial;")
           except Exception:
               pass  # Already installed

           # Import with DuckDB read_xlsx
           # Note: DuckDB's read_xlsx requires the spatial extension
           conn.execute(f"""
               CREATE OR REPLACE TABLE imported_data AS
               SELECT * FROM st_read(
                   '{file_path}',
                   layer = '{sheet}',
                   open_options = ['HEADERS={str(header).upper()}']
               )
           """)

           # Get schema
           schema_rows = conn.execute("DESCRIBE imported_data").fetchall()
           columns = []
           warnings = []

           for col_name, col_type, nullable, key, default, extra in schema_rows:
               col_warnings = []

               # Check for date columns
               if "DATE" in col_type.upper() or "TIMESTAMP" in col_type.upper():
                   sample = conn.execute(f"""
                       SELECT "{col_name}" FROM imported_data
                       WHERE "{col_name}" IS NOT NULL LIMIT 1
                   """).fetchone()
                   if sample:
                       date_result = parse_date_with_warnings(str(sample[0]))
                       col_warnings.extend(date_result.get("warnings", []))

               columns.append(SchemaColumn(
                   name=col_name,
                   type=col_type,
                   nullable=nullable == "YES",
                   warnings=[w.get("message", str(w)) if isinstance(w, dict) else str(w) for w in col_warnings]
               ))
               warnings.extend(col_warnings)

           # Get row count
           row_count = conn.execute("SELECT COUNT(*) FROM imported_data").fetchone()[0]

           return ImportResult(
               row_count=row_count,
               columns=columns,
               warnings=[w.get("message", str(w)) if isinstance(w, dict) else str(w) for w in warnings],
               source_type="excel"
           )

       def get_metadata(self, conn: DuckDBPyConnection) -> dict:
           """Get metadata about imported Excel data."""
           try:
               row_count = conn.execute("SELECT COUNT(*) FROM imported_data").fetchone()[0]
               columns = conn.execute("DESCRIBE imported_data").fetchall()
               return {
                   "row_count": row_count,
                   "column_count": len(columns),
                   "source_type": "excel"
               }
           except Exception:
               return {"error": "No data imported"}
   ```

2. Update `src/mcp/data_source/adapters/__init__.py` to export ExcelAdapter.

NOTE: DuckDB uses the spatial extension's st_read for Excel files. If st_read doesn't work well, fall back to using openpyxl directly to read data and insert into DuckDB. Test during implementation.
  </action>
  <verify>
    - `python -c "from src.mcp.data_source.adapters.excel_adapter import ExcelAdapter"` succeeds
    - ExcelAdapter().source_type returns "excel"
    - list_sheets method returns sheet names
  </verify>
  <done>ExcelAdapter class created with list_sheets, import_data, and get_metadata methods.</done>
</task>

<task type="auto">
  <name>Task 2: import_excel and list_sheets MCP Tools</name>
  <files>
    src/mcp/data_source/tools/import_tools.py
    src/mcp/data_source/server.py
  </files>
  <action>
Add import_excel and list_sheets tools to the MCP server.

1. Update `src/mcp/data_source/tools/import_tools.py` to add:
   ```python
   from ..adapters.excel_adapter import ExcelAdapter


   async def list_sheets(file_path: str, ctx: Context) -> dict:
       """List all sheets in an Excel file.

       Args:
           file_path: Absolute path to the Excel file (.xlsx)

       Returns:
           Dictionary with list of sheet names.

       Example:
           >>> result = await list_sheets("/path/to/workbook.xlsx", ctx)
           >>> print(result["sheets"])
           ["January Orders", "February Orders", "Summary"]
       """
       await ctx.info(f"Listing sheets in {file_path}")

       adapter = ExcelAdapter()
       sheets = adapter.list_sheets(file_path)

       await ctx.info(f"Found {len(sheets)} sheets")

       return {"sheets": sheets, "count": len(sheets)}


   async def import_excel(
       file_path: str,
       ctx: Context,
       sheet: str | None = None,
       header: bool = True,
   ) -> dict:
       """Import Excel sheet and discover schema.

       Args:
           file_path: Absolute path to the Excel file (.xlsx)
           sheet: Name of sheet to import (default: first sheet)
           header: Whether first row contains headers (default: True)

       Returns:
           Dictionary with schema, row_count, and any warnings.

       Example:
           >>> result = await import_excel("/path/to/orders.xlsx", ctx, sheet="January")
           >>> print(result["row_count"])
           250
       """
       db = ctx.request_context.lifespan_context["db"]

       await ctx.info(f"Importing Excel from {file_path}" + (f" sheet={sheet}" if sheet else ""))

       adapter = ExcelAdapter()
       result = adapter.import_data(
           conn=db,
           file_path=file_path,
           sheet=sheet,
           header=header,
       )

       # Update current source tracking
       ctx.request_context.lifespan_context["current_source"] = {
           "type": "excel",
           "path": file_path,
           "sheet": sheet,
           "row_count": result.row_count,
       }

       await ctx.info(f"Imported {result.row_count} rows with {len(result.columns)} columns")

       return result.model_dump()
   ```

2. Update `src/mcp/data_source/tools/__init__.py` to export new tools.

3. Update `src/mcp/data_source/server.py` to register new tools:
   ```python
   from .tools.import_tools import import_csv, import_excel, list_sheets

   mcp.tool()(import_csv)
   mcp.tool()(import_excel)
   mcp.tool()(list_sheets)
   ```
  </action>
  <verify>
    - `python -c "from src.mcp.data_source.server import mcp; print([t.name for t in mcp.list_tools()])"` shows import_excel and list_sheets
  </verify>
  <done>import_excel and list_sheets tools registered with FastMCP server.</done>
</task>

<task type="auto">
  <name>Task 3: Excel Import Tests</name>
  <files>
    tests/mcp/test_excel_import.py
  </files>
  <action>
Create tests to verify Excel import works end-to-end.

1. Create `tests/mcp/test_excel_import.py`:
   ```python
   """Test Excel import functionality."""

   import tempfile
   import pytest
   import duckdb
   from openpyxl import Workbook

   from src.mcp.data_source.adapters.excel_adapter import ExcelAdapter
   from src.mcp.data_source.models import ImportResult


   @pytest.fixture
   def sample_excel():
       """Create a temporary Excel file for testing."""
       wb = Workbook()

       # First sheet (default)
       ws1 = wb.active
       ws1.title = "Orders"
       ws1.append(["order_id", "customer", "amount", "state"])
       ws1.append([1001, "John Doe", 150.50, "CA"])
       ws1.append([1002, "Jane Smith", 200.00, "NY"])
       ws1.append([1003, "Bob Wilson", 75.25, "TX"])

       # Second sheet
       ws2 = wb.create_sheet("Returns")
       ws2.append(["return_id", "order_id", "reason"])
       ws2.append([1, 1001, "Damaged"])
       ws2.append([2, 1002, "Wrong item"])

       with tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False) as f:
           wb.save(f.name)
           return f.name


   @pytest.fixture
   def duckdb_conn():
       """Create in-memory DuckDB connection."""
       conn = duckdb.connect(":memory:")
       yield conn
       conn.close()


   def test_list_sheets(sample_excel):
       """Test listing sheets in Excel file."""
       adapter = ExcelAdapter()
       sheets = adapter.list_sheets(sample_excel)

       assert len(sheets) == 2
       assert "Orders" in sheets
       assert "Returns" in sheets


   def test_excel_import_default_sheet(sample_excel, duckdb_conn):
       """Test importing first sheet by default."""
       adapter = ExcelAdapter()
       result = adapter.import_data(duckdb_conn, sample_excel)

       assert isinstance(result, ImportResult)
       assert result.row_count == 3
       assert result.source_type == "excel"

       # Should have imported Orders sheet
       col_names = [c.name for c in result.columns]
       assert "order_id" in col_names or "ORDER_ID" in [c.upper() for c in col_names]


   def test_excel_import_specific_sheet(sample_excel, duckdb_conn):
       """Test importing a specific sheet."""
       adapter = ExcelAdapter()
       result = adapter.import_data(duckdb_conn, sample_excel, sheet="Returns")

       assert result.row_count == 2
       col_names = [c.name.lower() for c in result.columns]
       assert "return_id" in col_names or "returnid" in col_names


   def test_excel_file_not_found(duckdb_conn):
       """Test error handling for missing file."""
       adapter = ExcelAdapter()
       with pytest.raises(FileNotFoundError):
           adapter.import_data(duckdb_conn, "/nonexistent/file.xlsx")
   ```

2. Run tests: `pytest tests/mcp/test_excel_import.py -v`

NOTE: If DuckDB's st_read for Excel doesn't work reliably, modify ExcelAdapter to use openpyxl directly:
- Read data with openpyxl
- Convert to list of dicts
- Insert into DuckDB using conn.executemany or by creating a DataFrame
  </action>
  <verify>
    - `pytest tests/mcp/test_excel_import.py -v` passes all tests
    - Sheet listing works correctly
    - Sheet selection works correctly
  </verify>
  <done>Excel import tested: sheet listing, default sheet, specific sheet selection all verified.</done>
</task>

</tasks>

<verification>
Run these commands to verify plan completion:

```bash
cd /Users/matthewhans/Desktop/Programming/ShipAgent
source .venv/bin/activate

# Run Excel import tests
pytest tests/mcp/test_excel_import.py -v

# Verify tools are registered
python -c "
from src.mcp.data_source.server import mcp
tools = mcp.list_tools()
tool_names = [t.name for t in tools]
assert 'import_excel' in tool_names, f'import_excel not found in {tool_names}'
assert 'list_sheets' in tool_names, f'list_sheets not found in {tool_names}'
print('Excel tools registered successfully')
"

# Test with a real Excel file
python -c "
import tempfile
import duckdb
from openpyxl import Workbook
from src.mcp.data_source.adapters.excel_adapter import ExcelAdapter

# Create test Excel
wb = Workbook()
ws = wb.active
ws.title = 'TestSheet'
ws.append(['id', 'name', 'value'])
ws.append([1, 'Alice', 100])
ws.append([2, 'Bob', 200])

with tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False) as f:
    wb.save(f.name)
    xlsx_path = f.name

adapter = ExcelAdapter()
sheets = adapter.list_sheets(xlsx_path)
print(f'Sheets: {sheets}')

conn = duckdb.connect(':memory:')
result = adapter.import_data(conn, xlsx_path)
print(f'Imported {result.row_count} rows')
assert result.row_count == 2
print('Excel import working correctly')
"
```
</verification>

<success_criteria>
1. ExcelAdapter class implements BaseSourceAdapter interface
2. list_sheets returns all sheet names from Excel file
3. import_excel imports specified sheet (or first sheet by default)
4. Both tools registered with MCP server
5. Schema discovery works for Excel data
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-source-mcp/02-03-SUMMARY.md`
</output>
