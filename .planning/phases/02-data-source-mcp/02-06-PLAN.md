---
phase: 02-data-source-mcp
plan: 06
type: execute
wave: 4
depends_on: ["02-05"]
files_modified:
  - src/mcp/data_source/server.py
  - tests/mcp/test_integration.py
autonomous: false

must_haves:
  truths:
    - "MCP server runs via stdio transport"
    - "All 12 tools are accessible via MCP protocol"
    - "CSV import end-to-end works through MCP"
    - "Checksums computed correctly through MCP"
  artifacts:
    - path: "src/mcp/data_source/server.py"
      provides: "Complete FastMCP server with all tools"
      exports: ["mcp"]
    - path: "tests/mcp/test_integration.py"
      provides: "Integration tests for MCP tools"
  key_links:
    - from: "src/mcp/data_source/server.py"
      to: "all tool modules"
      via: "mcp.tool() registration"
      pattern: "mcp\\.tool\\(\\)"
---

<objective>
Finalize the Data Source MCP server, run integration tests, and verify all requirements are met.

Purpose: Complete Phase 2 with a working MCP server that satisfies DATA-01, DATA-02, DATA-03, DATA-05, and ORCH-02 requirements.

Output: Production-ready Data Source MCP server verified via integration tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-source-mcp/02-CONTEXT.md
@.planning/phases/02-data-source-mcp/02-RESEARCH.md
@.planning/phases/02-data-source-mcp/02-01-SUMMARY.md
@.planning/phases/02-data-source-mcp/02-02-SUMMARY.md
@.planning/phases/02-data-source-mcp/02-03-SUMMARY.md
@.planning/phases/02-data-source-mcp/02-04-SUMMARY.md
@.planning/phases/02-data-source-mcp/02-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Final Server Assembly and Export</name>
  <files>
    src/mcp/data_source/server.py
    src/mcp/data_source/__init__.py
  </files>
  <action>
Ensure the server.py has all tools properly registered and the package exports are correct.

1. Verify `src/mcp/data_source/server.py` has all 12 tools registered:
   ```python
   """Data Source MCP Server.

   FastMCP server for importing and querying shipment data from
   CSV, Excel, and database sources.

   Usage:
       python -m src.mcp.data_source.server
   """

   from contextlib import asynccontextmanager
   from fastmcp import FastMCP
   import duckdb


   @asynccontextmanager
   async def lifespan(app):
       """Initialize DuckDB with database extensions."""
       conn = duckdb.connect(":memory:")

       # Install extensions for database connectivity
       conn.execute("INSTALL postgres; INSTALL mysql;")
       conn.execute("LOAD postgres; LOAD mysql;")

       yield {
           "db": conn,
           "current_source": None,
           "type_overrides": {},
       }

       conn.close()


   mcp = FastMCP("DataSource", lifespan=lifespan)


   # Import tools
   from .tools.import_tools import (
       import_csv,
       import_excel,
       list_sheets,
       import_database,
       list_tables,
   )
   from .tools.schema_tools import get_schema, override_column_type
   from .tools.query_tools import get_row, get_rows_by_filter, query_data
   from .tools.checksum_tools import compute_checksums, verify_checksum


   # Register all tools
   mcp.tool()(import_csv)
   mcp.tool()(import_excel)
   mcp.tool()(list_sheets)
   mcp.tool()(import_database)
   mcp.tool()(list_tables)
   mcp.tool()(get_schema)
   mcp.tool()(override_column_type)
   mcp.tool()(get_row)
   mcp.tool()(get_rows_by_filter)
   mcp.tool()(query_data)
   mcp.tool()(compute_checksums)
   mcp.tool()(verify_checksum)


   if __name__ == "__main__":
       mcp.run(transport="stdio")
   ```

2. Update `src/mcp/data_source/__init__.py` for clean exports:
   ```python
   """Data Source MCP package.

   Provides MCP server for importing and querying shipment data.
   """

   from .server import mcp
   from .models import (
       SchemaColumn,
       ImportResult,
       RowData,
       QueryResult,
       ChecksumResult,
   )
   from .adapters.base import BaseSourceAdapter
   from .adapters.csv_adapter import CSVAdapter
   from .adapters.excel_adapter import ExcelAdapter
   from .adapters.db_adapter import DatabaseAdapter

   __all__ = [
       "mcp",
       "SchemaColumn",
       "ImportResult",
       "RowData",
       "QueryResult",
       "ChecksumResult",
       "BaseSourceAdapter",
       "CSVAdapter",
       "ExcelAdapter",
       "DatabaseAdapter",
   ]
   ```

3. Ensure all tools/__init__.py exports are complete.
  </action>
  <verify>
    - `python -c "from src.mcp.data_source import mcp; print(len(mcp.list_tools()))"` returns 12
    - `python -c "from src.mcp.data_source import CSVAdapter, ExcelAdapter, DatabaseAdapter"` succeeds
  </verify>
  <done>Server fully assembled with all 12 tools. Package exports clean.</done>
</task>

<task type="auto">
  <name>Task 2: Integration Tests</name>
  <files>
    tests/mcp/test_integration.py
  </files>
  <action>
Create comprehensive integration tests that test the full MCP workflow.

1. Create `tests/mcp/test_integration.py`:
   ```python
   """Integration tests for Data Source MCP.

   Tests the complete workflow through adapters (not MCP protocol).
   MCP protocol testing requires running the server.
   """

   import tempfile
   import pytest
   import duckdb
   from openpyxl import Workbook

   from src.mcp.data_source import CSVAdapter, ExcelAdapter
   from src.mcp.data_source.utils import compute_row_checksum


   @pytest.fixture
   def duckdb_conn():
       """Create in-memory DuckDB connection."""
       conn = duckdb.connect(":memory:")
       yield conn
       conn.close()


   class TestCSVWorkflow:
       """Test complete CSV import workflow."""

       @pytest.fixture
       def csv_file(self):
           content = """order_id,customer_name,address,city,state,zip,weight
   1001,Alice Johnson,123 Main St,Los Angeles,CA,90001,5.5
   1002,Bob Smith,456 Oak Ave,New York,NY,10001,3.2
   1003,Carol White,789 Pine Rd,Houston,TX,77001,7.8
   1004,David Brown,321 Elm St,Miami,FL,33101,2.1"""

           with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
               f.write(content)
               return f.name

       def test_import_and_query(self, csv_file, duckdb_conn):
           """Test import CSV then query rows."""
           adapter = CSVAdapter()

           # Import
           result = adapter.import_data(duckdb_conn, csv_file)
           assert result.row_count == 4
           assert len(result.columns) == 7

           # Query specific state
           ca_rows = duckdb_conn.execute("""
               SELECT * FROM imported_data WHERE state = 'CA'
           """).fetchall()
           assert len(ca_rows) == 1
           assert ca_rows[0][1] == "Alice Johnson"

       def test_checksum_consistency(self, csv_file, duckdb_conn):
           """Test that checksums are consistent across imports."""
           adapter = CSVAdapter()
           adapter.import_data(duckdb_conn, csv_file)

           # Get first row and compute checksum
           row1 = duckdb_conn.execute("SELECT * FROM imported_data LIMIT 1").fetchone()
           columns = [desc[0] for desc in duckdb_conn.description]
           row_dict = dict(zip(columns, row1))

           checksum1 = compute_row_checksum(row_dict)

           # Re-import and verify checksum is same
           adapter.import_data(duckdb_conn, csv_file)
           row1_again = duckdb_conn.execute("SELECT * FROM imported_data LIMIT 1").fetchone()
           row_dict_again = dict(zip(columns, row1_again))

           checksum2 = compute_row_checksum(row_dict_again)

           assert checksum1 == checksum2


   class TestExcelWorkflow:
       """Test complete Excel import workflow."""

       @pytest.fixture
       def excel_file(self):
           wb = Workbook()

           ws1 = wb.active
           ws1.title = "January"
           ws1.append(["order_id", "customer", "amount"])
           ws1.append([1001, "Alice", 150.50])
           ws1.append([1002, "Bob", 200.00])

           ws2 = wb.create_sheet("February")
           ws2.append(["order_id", "customer", "amount"])
           ws2.append([2001, "Carol", 175.25])

           with tempfile.NamedTemporaryFile(suffix='.xlsx', delete=False) as f:
               wb.save(f.name)
               return f.name

       def test_list_and_import_sheets(self, excel_file, duckdb_conn):
           """Test listing sheets and importing specific one."""
           adapter = ExcelAdapter()

           # List sheets
           sheets = adapter.list_sheets(excel_file)
           assert "January" in sheets
           assert "February" in sheets

           # Import specific sheet
           result = adapter.import_data(duckdb_conn, excel_file, sheet="February")
           assert result.row_count == 1  # Only one data row in February


   class TestAllToolsRegistered:
       """Verify all expected tools are registered."""

       def test_tool_count(self):
           from src.mcp.data_source import mcp

           tools = mcp.list_tools()
           assert len(tools) == 12, f"Expected 12 tools, got {len(tools)}"

       def test_tool_names(self):
           from src.mcp.data_source import mcp

           tool_names = [t.name for t in mcp.list_tools()]

           expected = [
               "import_csv", "import_excel", "list_sheets",
               "import_database", "list_tables",
               "get_schema", "override_column_type",
               "get_row", "get_rows_by_filter", "query_data",
               "compute_checksums", "verify_checksum"
           ]

           for name in expected:
               assert name in tool_names, f"Tool '{name}' not found"


   class TestRequirementsCoverage:
       """Verify Phase 2 requirements are covered."""

       def test_data_01_csv_import(self):
           """DATA-01: CSV with schema discovery."""
           from src.mcp.data_source import mcp
           tools = [t.name for t in mcp.list_tools()]
           assert "import_csv" in tools

       def test_data_02_excel_import(self):
           """DATA-02: Excel with sheet selection."""
           from src.mcp.data_source import mcp
           tools = [t.name for t in mcp.list_tools()]
           assert "import_excel" in tools
           assert "list_sheets" in tools

       def test_data_03_database_import(self):
           """DATA-03: Database via connection string."""
           from src.mcp.data_source import mcp
           tools = [t.name for t in mcp.list_tools()]
           assert "import_database" in tools
           assert "list_tables" in tools

       def test_data_05_checksums(self):
           """DATA-05: SHA-256 row checksums."""
           from src.mcp.data_source import mcp
           tools = [t.name for t in mcp.list_tools()]
           assert "compute_checksums" in tools
           assert "verify_checksum" in tools

       def test_orch_02_mcp_server(self):
           """ORCH-02: FastMCP server with stdio transport."""
           from src.mcp.data_source import mcp
           assert mcp is not None
           # Server can run via: python -m src.mcp.data_source.server
   ```

2. Run all tests: `pytest tests/mcp/ -v`
  </action>
  <verify>
    - `pytest tests/mcp/test_integration.py -v` passes all tests
    - Requirements coverage tests pass (DATA-01, DATA-02, DATA-03, DATA-05, ORCH-02)
  </verify>
  <done>Integration tests passing. All requirements verified covered.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Data Source MCP server with:
- CSV import with schema discovery
- Excel import with sheet selection
- Database import (PostgreSQL/MySQL) with large table protection
- Schema inspection and type override
- Row querying and filtering
- SHA-256 checksum computation and verification
- All exposed as MCP tools via FastMCP
  </what-built>
  <how-to-verify>
1. Run full test suite:
   ```bash
   cd /Users/matthewhans/Desktop/Programming/ShipAgent
   source .venv/bin/activate
   pytest tests/mcp/ -v
   ```

2. Verify server starts:
   ```bash
   python -c "
   from src.mcp.data_source import mcp
   print('Tools available:')
   for tool in mcp.list_tools():
       print(f'  - {tool.name}')
   "
   ```

3. Test CSV import manually:
   ```bash
   python -c "
   import tempfile
   import duckdb
   from src.mcp.data_source import CSVAdapter
   from src.mcp.data_source.utils import compute_row_checksum

   # Create test CSV
   content = '''name,city,state
   Alice,LA,CA
   Bob,NYC,NY'''

   with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
       f.write(content)
       csv_path = f.name

   conn = duckdb.connect(':memory:')
   adapter = CSVAdapter()
   result = adapter.import_data(conn, csv_path)

   print(f'Imported {result.row_count} rows')
   print(f'Columns: {[c.name for c in result.columns]}')

   # Get row with checksum
   row = conn.execute('SELECT * FROM imported_data LIMIT 1').fetchone()
   cols = [d[0] for d in conn.description]
   row_dict = dict(zip(cols, row))
   checksum = compute_row_checksum(row_dict)
   print(f'Row 1: {row_dict}')
   print(f'Checksum: {checksum}')
   "
   ```

4. Verify all tests pass and output looks correct.
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass and manual verification works. Describe any issues if not.</resume-signal>
</task>

</tasks>

<verification>
Final verification checklist:

```bash
cd /Users/matthewhans/Desktop/Programming/ShipAgent
source .venv/bin/activate

# Run ALL MCP tests
pytest tests/mcp/ -v --tb=short

# Verify tool count
python -c "
from src.mcp.data_source import mcp
tools = mcp.list_tools()
print(f'Total tools: {len(tools)}')
assert len(tools) == 12, f'Expected 12, got {len(tools)}'
print('All 12 tools registered')
"

# Verify package exports
python -c "
from src.mcp.data_source import (
    mcp,
    CSVAdapter,
    ExcelAdapter,
    DatabaseAdapter,
    SchemaColumn,
    ImportResult,
)
print('All exports available')
"

# Quick smoke test
python -c "
import tempfile
import duckdb
from src.mcp.data_source import CSVAdapter
from src.mcp.data_source.utils import compute_row_checksum

csv = 'id,val\\n1,100\\n2,200'
with tempfile.NamedTemporaryFile(mode='w', suffix='.csv', delete=False) as f:
    f.write(csv)
    path = f.name

conn = duckdb.connect(':memory:')
result = CSVAdapter().import_data(conn, path)
assert result.row_count == 2
print('Smoke test passed')
"
```
</verification>

<success_criteria>
1. All 12 MCP tools registered and accessible
2. pytest tests/mcp/ passes with no failures
3. CSV import works end-to-end
4. Excel import with sheet selection works
5. Database adapter correctly detects postgres/mysql
6. Checksums are deterministic
7. Server can be started via `python -m src.mcp.data_source.server`
8. Human verification confirms functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-source-mcp/02-06-SUMMARY.md`
</output>
